<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BlockVerse â€” 3D Multiplayer</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#07070f;--bg2:#0d0d1a;--bg3:#13131f;--card:#16162a;
  --border:#1e1e38;--cyan:#00e5ff;--cyan2:#00b8d4;
  --orange:#ff6b35;--green:#39ff14;--red:#ff3355;
  --gold:#ffd700;--purple:#a855f7;--muted:#5a5a88;
  --text:#ddddf8;--font:'Rajdhani',sans-serif;
  --mono:'Fira Code',monospace;--pixel:'Press Start 2P',monospace;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* â”€â”€ SCREENS â”€â”€ */
.screen{position:fixed;inset:0;display:none;z-index:10;}
.screen.visible{display:flex;}

/* â”€â”€ LOBBY â”€â”€ */
#screen-lobby{flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 30% 60%,rgba(168,85,247,.18) 0%,transparent 60%),
             radial-gradient(ellipse at 70% 20%,rgba(0,229,255,.14) 0%,transparent 55%),var(--bg);}
.lobby-grid{position:fixed;inset:0;
  background-image:linear-gradient(rgba(0,229,255,.04) 1px,transparent 1px),
                   linear-gradient(90deg,rgba(0,229,255,.04) 1px,transparent 1px);
  background-size:48px 48px;pointer-events:none;}
.logo{font-family:var(--pixel);font-size:clamp(18px,5vw,38px);color:var(--cyan);
  text-shadow:0 0 30px rgba(0,229,255,.5),0 0 60px rgba(0,229,255,.2);margin-bottom:10px;letter-spacing:3px;}
.logo-sub{font-size:clamp(13px,2vw,17px);color:var(--muted);margin-bottom:40px;font-weight:600;}
.join-card{background:rgba(13,13,26,.95);border:1px solid var(--border);border-radius:20px;
  padding:32px;width:min(420px,92vw);backdrop-filter:blur(10px);}
.input-group{margin-bottom:16px;}
.input-group label{display:block;font-size:13px;color:var(--muted);font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;}
.inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;
  padding:11px 14px;color:var(--text);font-family:var(--font);font-size:15px;outline:none;transition:.2s;}
.inp:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,229,255,.1);}
.color-row{display:flex;gap:8px;flex-wrap:wrap;}
.color-swatch{width:32px;height:32px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:.2s;}
.color-swatch.active{border-color:#fff;transform:scale(1.15);}
.rooms-list{display:flex;flex-direction:column;gap:8px;max-height:180px;overflow-y:auto;margin-bottom:16px;}
.room-item{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;
  cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:space-between;}
.room-item:hover,.room-item.selected{border-color:var(--cyan);background:rgba(0,229,255,.06);}
.room-name{font-weight:700;font-size:15px;}
.room-count{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:5px;}
.dot-online{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);}
.btn-join{width:100%;padding:13px;border-radius:12px;border:none;
  background:linear-gradient(135deg,var(--cyan),var(--cyan2));
  color:#000;font-family:var(--font);font-size:16px;font-weight:700;cursor:pointer;transition:.2s;margin-top:4px;}
.btn-join:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,229,255,.4);}
.btn-join:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.status-bar{font-size:12px;color:var(--muted);text-align:center;margin-top:12px;min-height:18px;}

/* â”€â”€ SIDEBAR NAV â”€â”€ */
#sidebar{position:fixed;left:0;top:0;bottom:0;width:60px;background:rgba(7,7,15,.9);
  border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;
  padding:10px 0;gap:4px;z-index:100;backdrop-filter:blur(12px);}
.logo-icon{width:42px;height:42px;border-radius:11px;background:linear-gradient(135deg,var(--cyan),var(--purple));
  display:flex;align-items:center;justify-content:center;margin-bottom:14px;cursor:pointer;font-family:var(--pixel);font-size:14px;color:#fff;}
.nav-item{width:46px;height:46px;border-radius:11px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--muted);font-size:19px;transition:.2s;position:relative;border:1px solid transparent;}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:rgba(0,229,255,.12);color:var(--cyan);border-color:rgba(0,229,255,.25);}
.nav-item.active::before{content:'';position:absolute;left:-1px;top:50%;transform:translateY(-50%);
  width:3px;height:22px;background:var(--cyan);border-radius:0 3px 3px 0;}
.nav-tooltip{position:absolute;left:56px;background:var(--bg2);border:1px solid var(--border);
  color:var(--text);padding:5px 10px;border-radius:7px;font-size:12px;white-space:nowrap;
  pointer-events:none;opacity:0;transition:.15s;z-index:999;font-weight:700;}
.nav-item:hover .nav-tooltip{opacity:1;}
.sidebar-bottom{margin-top:auto;display:flex;flex-direction:column;align-items:center;gap:8px;}
.avatar-orb{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:15px;color:#fff;cursor:pointer;border:2px solid transparent;}

/* â”€â”€ PANELS (right of sidebar) â”€â”€ */
.panel{position:fixed;left:60px;top:0;right:0;bottom:0;display:none;}
.panel.visible{display:flex;flex-direction:column;}

/* â”€â”€ GAME PANEL â”€â”€ */
#panel-game{background:#000;}
#gameCanvas{display:block;width:100%;height:100%;}
/* HUD */
#hud{position:fixed;top:0;left:60px;right:0;z-index:50;
  background:linear-gradient(180deg,rgba(7,7,15,.8) 0%,transparent 100%);
  padding:12px 16px;display:flex;align-items:center;gap:12px;pointer-events:none;}
#hud .room-label{font-family:var(--pixel);font-size:9px;color:var(--cyan);}
#hud .player-ct{font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:5px;}
.hud-hp{display:flex;align-items:center;gap:8px;margin-left:auto;pointer-events:all;}
.hud-hp span{font-size:12px;color:var(--muted);}
.hp-bar{width:100px;height:7px;background:var(--bg3);border-radius:4px;overflow:hidden;}
.hp-fill{height:100%;background:linear-gradient(90deg,var(--red),var(--orange),var(--green));border-radius:4px;transition:.3s;}
.hud-leave{pointer-events:all;background:rgba(255,51,85,.15);border:1px solid rgba(255,51,85,.3);
  color:var(--red);padding:5px 12px;border-radius:8px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;margin-left:8px;}
.hud-leave:hover{background:rgba(255,51,85,.3);}
/* Crosshair */
#crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  pointer-events:none;z-index:60;display:none;}
#crosshair::before,#crosshair::after{content:'';position:absolute;background:rgba(255,255,255,.8);border-radius:1px;}
#crosshair::before{width:14px;height:2px;top:-1px;left:-7px;}
#crosshair::after{width:2px;height:14px;top:-7px;left:-1px;}
/* PLAYERS PANEL */
#players-panel{position:fixed;top:56px;right:14px;background:rgba(7,7,15,.88);
  border:1px solid var(--border);border-radius:14px;padding:12px;width:160px;z-index:50;backdrop-filter:blur(8px);}
.pp-title{font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.pp-player{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px;font-weight:600;}
.pp-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
/* CHAT */
#chat-wrap{position:fixed;bottom:14px;left:76px;width:280px;z-index:50;}
#chat-messages{background:rgba(7,7,15,.85);border:1px solid var(--border);border-radius:12px 12px 0 0;
  height:120px;overflow-y:auto;padding:10px 12px;font-size:12px;line-height:1.8;backdrop-filter:blur(8px);}
.chat-line{margin-bottom:1px;}
.chat-sender{font-weight:700;}
#chat-form{display:flex;}
#chat-input{flex:1;background:rgba(7,7,15,.92);border:1px solid var(--border);border-right:none;
  border-top:none;border-radius:0 0 0 12px;padding:8px 11px;color:var(--text);
  font-family:var(--font);font-size:13px;outline:none;}
#chat-submit{background:var(--cyan);color:#000;border:none;padding:8px 14px;
  border-radius:0 0 12px 0;cursor:pointer;font-weight:700;font-family:var(--font);}
/* Block picker (studio in game) */
#block-picker{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);
  background:rgba(7,7,15,.9);border:1px solid var(--border);border-radius:14px;
  padding:8px;display:flex;gap:6px;z-index:50;backdrop-filter:blur(8px);}
.bp-slot{width:44px;height:44px;border-radius:9px;border:2px solid var(--border);
  cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:.15s;}
.bp-slot:hover,.bp-slot.active{border-color:var(--cyan);background:rgba(0,229,255,.1);}
/* Notif */
.notif{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--cyan);
  border-radius:11px;padding:12px 18px;z-index:999;font-weight:700;font-size:14px;color:var(--cyan);
  animation:notifIn .25s ease;max-width:280px;pointer-events:none;}
@keyframes notifIn{from{transform:translateY(10px);opacity:0;}to{transform:translateY(0);opacity:1;}}
/* Mobile joystick */
#joy-wrap{position:fixed;bottom:100px;right:22px;z-index:60;touch-action:none;display:none;}
.joy-base{width:96px;height:96px;border-radius:50%;background:rgba(255,255,255,.08);
  border:2px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;touch-action:none;}
.joy-stick{width:40px;height:40px;border-radius:50%;background:rgba(0,229,255,.5);
  border:2px solid var(--cyan);position:absolute;pointer-events:none;}
#mob-jump{position:fixed;bottom:180px;right:30px;z-index:60;width:56px;height:56px;
  border-radius:50%;background:rgba(255,107,53,.7);border:2px solid var(--orange);
  display:none;align-items:center;justify-content:center;font-size:22px;cursor:pointer;touch-action:none;}

/* â”€â”€ STUDIO PANEL â”€â”€ */
#panel-studio{background:var(--bg);overflow:hidden;}
.studio-header{background:var(--bg2);border-bottom:1px solid var(--border);
  padding:10px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;flex-shrink:0;}
.studio-title{font-family:var(--pixel);font-size:9px;color:var(--cyan);margin-right:8px;}
.tool-group{display:flex;gap:3px;padding-right:10px;border-right:1px solid var(--border);}
.tbtn{width:34px;height:34px;border-radius:8px;border:1px solid transparent;background:transparent;
  color:var(--muted);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:.15s;}
.tbtn:hover{background:var(--bg3);color:var(--text);}
.tbtn.active{background:rgba(0,229,255,.12);border-color:rgba(0,229,255,.3);color:var(--cyan);}
.studio-body{flex:1;display:flex;overflow:hidden;}
.studio-sidebar{width:170px;min-width:170px;background:var(--bg2);border-right:1px solid var(--border);
  padding:12px;overflow-y:auto;flex-shrink:0;}
.s-title{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;}
.block-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.block-btn{padding:7px 4px;border-radius:8px;border:1px solid var(--border);cursor:pointer;
  text-align:center;background:var(--bg3);transition:.15s;}
.block-btn:hover,.block-btn.sel{border-color:var(--cyan);background:rgba(0,229,255,.08);}
.block-icon{font-size:22px;display:block;margin-bottom:3px;}
.block-label{font-size:10px;color:var(--muted);font-weight:700;}
.studio-3d{flex:1;position:relative;overflow:hidden;}
#studioCanvas{display:block;width:100%;height:100%;}
.studio-info{position:absolute;bottom:12px;left:12px;background:rgba(7,7,15,.8);
  border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-size:12px;color:var(--muted);}
.studio-right{width:160px;min-width:160px;background:var(--bg2);border-left:1px solid var(--border);padding:12px;overflow-y:auto;}
.prop-row{margin-bottom:12px;}
.prop-label{font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-bottom:5px;display:block;}
.prop-inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:7px;
  padding:6px 8px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;}
.prop-inp:focus{border-color:var(--cyan);}
.action-btn{width:100%;padding:8px;border-radius:8px;border:none;cursor:pointer;
  font-family:var(--font);font-size:13px;font-weight:700;margin-bottom:6px;transition:.2s;}
.ab-primary{background:linear-gradient(135deg,var(--cyan),var(--cyan2));color:#000;}
.ab-primary:hover{box-shadow:0 4px 16px rgba(0,229,255,.35);}
.ab-success{background:rgba(57,255,20,.1);color:var(--green);border:1px solid rgba(57,255,20,.25);}
.ab-danger{background:rgba(255,51,85,.1);color:var(--red);border:1px solid rgba(255,51,85,.25);}

/* â”€â”€ SCRIPT PANEL â”€â”€ */
#panel-script{overflow:hidden;background:var(--bg);}
.editor-bar{background:var(--bg2);border-bottom:1px solid var(--border);
  padding:10px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.editor-ttl{font-family:var(--pixel);font-size:9px;color:var(--cyan);}
.file-tabs{display:flex;gap:3px;overflow-x:auto;}
.ftab{padding:5px 12px;border-radius:7px 7px 0 0;font-size:12px;font-weight:700;cursor:pointer;
  border:1px solid var(--border);border-bottom:none;background:var(--bg3);color:var(--muted);white-space:nowrap;}
.ftab.active{background:var(--bg);color:var(--cyan);border-color:var(--border);}
.editor-body{flex:1;display:flex;overflow:hidden;}
.file-tree{width:170px;min-width:170px;background:var(--bg2);border-right:1px solid var(--border);padding:12px;overflow-y:auto;}
.ft-title{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;}
.ft-item{display:flex;align-items:center;gap:7px;padding:6px 8px;border-radius:7px;cursor:pointer;
  font-size:13px;font-weight:600;transition:.15s;color:var(--muted);}
.ft-item:hover{background:var(--bg3);color:var(--text);}
.ft-item.active{background:rgba(0,229,255,.08);color:var(--cyan);}
.editor-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.code-wrap{flex:1;display:flex;overflow:hidden;}
.line-nums{background:var(--bg2);border-right:1px solid var(--border);padding:14px 10px;
  font-family:var(--mono);font-size:13px;line-height:22px;color:var(--muted);text-align:right;
  user-select:none;min-width:48px;overflow:hidden;}
#codeEditor{flex:1;background:var(--bg);padding:14px;font-family:var(--mono);font-size:13px;
  line-height:22px;color:var(--text);border:none;outline:none;resize:none;overflow:auto;tab-size:2;}
.console-pane{height:140px;background:var(--bg2);border-top:1px solid var(--border);display:flex;flex-direction:column;}
.console-hdr{padding:7px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;
  font-size:12px;font-weight:700;color:var(--muted);}
.console-out{flex:1;overflow-y:auto;padding:8px 14px;font-family:var(--mono);font-size:12px;line-height:1.9;}
.cl{color:var(--text)}.ce{color:var(--red)}.ci{color:var(--cyan)}.cs{color:var(--green)}

/* â”€â”€ BROWSE PANEL â”€â”€ */
#panel-browse{background:var(--bg);overflow-y:auto;padding:24px 24px 24px 24px;}
.browse-title{font-family:var(--pixel);font-size:11px;color:var(--cyan);margin-bottom:20px;}
.rooms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;}
.rcard{background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;cursor:pointer;transition:.22s;}
.rcard:hover{transform:translateY(-5px);border-color:var(--cyan);box-shadow:0 10px 40px rgba(0,229,255,.18);}
.rcard-thumb{height:120px;display:flex;align-items:center;justify-content:center;font-size:56px;position:relative;}
.rcard-pc{position:absolute;bottom:8px;right:10px;background:rgba(0,0,0,.7);border-radius:20px;
  padding:3px 10px;font-size:12px;color:var(--green);font-weight:700;display:flex;align-items:center;gap:4px;}
.rcard-body{padding:14px;}
.rcard-name{font-size:16px;font-weight:700;margin-bottom:6px;}
.rcard-desc{font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.5;}
.rcard-join{width:100%;padding:9px;border-radius:9px;border:none;
  background:linear-gradient(135deg,var(--cyan),var(--cyan2));color:#000;
  font-family:var(--font);font-size:14px;font-weight:700;cursor:pointer;transition:.2s;}
.rcard-join:hover{box-shadow:0 4px 18px rgba(0,229,255,.4);}

/* RESPONSIVE */
@media(max-width:768px){
  #sidebar{width:50px;}
  .panel{left:50px;}
  #hud{left:50px;}
  #chat-wrap{left:60px;width:220px;}
  #joy-wrap{display:block;}
  #mob-jump{display:flex;}
  #players-panel{display:none;}
  #block-picker{display:none;}
  .studio-right{display:none;}
  .studio-sidebar{width:130px;min-width:130px;}
  .file-tree{width:130px;min-width:130px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-lobby" class="screen visible">
  <div class="lobby-grid"></div>
  <div style="text-align:center;z-index:1;">
    <div class="logo">BLOCKVERSE</div>
    <div class="logo-sub">3D Multiplayer Game Platform</div>
    <div class="join-card">
      <div class="input-group">
        <label>Your Name</label>
        <input class="inp" id="inp-name" placeholder="Enter username..." maxlength="20" value="Player">
      </div>
      <div class="input-group">
        <label>Color</label>
        <div class="color-row" id="color-row"></div>
      </div>
      <div class="input-group">
        <label>Select Room</label>
        <div class="rooms-list" id="rooms-list">
          <div style="color:var(--muted);font-size:13px;">Connecting to server...</div>
        </div>
      </div>
      <button class="btn-join" id="btn-join" disabled onclick="joinRoom()">â–¶ Join World</button>
      <div class="status-bar" id="status-bar">Connecting...</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="sidebar" style="display:none;">
  <div class="logo-icon">B</div>
  <div class="nav-item active" id="nav-game" onclick="showPanel('game')">ğŸ®<span class="nav-tooltip">Play</span></div>
  <div class="nav-item" id="nav-browse" onclick="showPanel('browse')">ğŸŒ<span class="nav-tooltip">Rooms</span></div>
  <div class="nav-item" id="nav-studio" onclick="showPanel('studio')">ğŸ—ï¸<span class="nav-tooltip">Studio</span></div>
  <div class="nav-item" id="nav-script" onclick="showPanel('script')">ğŸ“œ<span class="nav-tooltip">Scripts</span></div>
  <div class="sidebar-bottom">
    <div class="nav-item" onclick="toggleCrosshair()">ğŸ¯<span class="nav-tooltip">Aim Mode</span></div>
    <div class="avatar-orb" id="my-avatar" onclick="showNotif('Profile coming soon!','ğŸ‘¤')"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="panel-game" class="panel">
  <canvas id="gameCanvas"></canvas>
  <div id="hud">
    <div class="room-label" id="hud-room">LOADING...</div>
    <div class="player-ct"><div class="dot-online"></div><span id="hud-pcount">0 Players</span></div>
    <div class="hud-hp">
      <span>HP</span>
      <div class="hp-bar"><div class="hp-fill" id="hp-fill" style="width:100%"></div></div>
      <span id="hp-val">100</span>
    </div>
    <button class="hud-leave" onclick="leaveGame()">â¬… Leave</button>
  </div>
  <div id="crosshair"></div>
  <div id="players-panel">
    <div class="pp-title">Players Online</div>
    <div id="pp-list"></div>
  </div>
  <div id="chat-wrap">
    <div id="chat-messages"></div>
    <form id="chat-form" onsubmit="sendChat(event)">
      <input id="chat-input" placeholder="Press T to chat..." autocomplete="off">
      <button type="submit" id="chat-submit">â†µ</button>
    </form>
  </div>
  <div id="block-picker">
    <!-- filled by JS -->
  </div>
  <div id="joy-wrap">
    <div class="joy-base" id="joy-base"><div class="joy-stick" id="joy-stick"></div></div>
  </div>
  <div id="mob-jump" ontouchstart="doJump()">â¬†</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BROWSE PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="panel-browse" class="panel">
  <div class="browse-title">AVAILABLE WORLDS</div>
  <div class="rooms-grid" id="browse-rooms-grid"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STUDIO PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="panel-studio" class="panel">
  <div class="studio-header">
    <span class="studio-title">3D STUDIO</span>
    <div class="tool-group">
      <button class="tbtn active" id="stbtn-place" onclick="setStudioTool('place')" title="Place">ğŸ§±</button>
      <button class="tbtn" id="stbtn-erase" onclick="setStudioTool('erase')" title="Erase">â¬œ</button>
      <button class="tbtn" id="stbtn-pick" onclick="setStudioTool('pick')" title="Pick Color">ğŸ¨</button>
    </div>
    <div class="tool-group">
      <button class="tbtn" onclick="undoStudio()" title="Undo">â†©ï¸</button>
      <button class="tbtn" onclick="clearStudio()" title="Clear All">ğŸ—‘ï¸</button>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      <button class="action-btn ab-primary" style="width:auto;padding:7px 14px;margin:0;" onclick="applyStudioMap()">ğŸ“¤ Push to Server</button>
    </div>
  </div>
  <div class="studio-body">
    <div class="studio-sidebar">
      <div class="s-title">Blocks</div>
      <div class="block-grid" id="studio-block-grid"></div>
    </div>
    <div class="studio-3d">
      <canvas id="studioCanvas"></canvas>
      <div class="studio-info">LMB: Place &nbsp;|&nbsp; RMB: Erase &nbsp;|&nbsp; Scroll: Zoom &nbsp;|&nbsp; Mid-drag: Orbit</div>
    </div>
    <div class="studio-right">
      <div class="s-title">Map Settings</div>
      <div class="prop-row"><label class="prop-label">Map Name</label><input class="prop-inp" id="map-name" value="My World"></div>
      <div class="prop-row"><label class="prop-label">Sky</label>
        <select class="prop-inp" id="map-sky" onchange="updateStudioSky()">
          <option value="day">â˜€ï¸ Day</option><option value="night">ğŸŒ™ Night</option>
          <option value="dusk">ğŸŒ† Dusk</option><option value="space">ğŸš€ Space</option>
        </select>
      </div>
      <div class="prop-row"><label class="prop-label">Fog</label>
        <select class="prop-inp" id="map-fog">
          <option value="none">None</option><option value="light">Light</option><option value="heavy">Heavy</option>
        </select>
      </div>
      <div class="s-title" style="margin-top:16px;">Objects</div>
      <button class="action-btn ab-success" onclick="showNotif('Spawn added!','ğŸ“')">ğŸ“ Add Spawn</button>
      <button class="action-btn ab-success" onclick="showNotif('Portal added!','ğŸŒ€')">ğŸŒ€ Add Portal</button>
      <button class="action-btn ab-danger" onclick="clearStudio()">ğŸ—‘ï¸ Clear All</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="panel-script" class="panel">
  <div class="editor-bar">
    <span class="editor-ttl">LUA SCRIPT EDITOR</span>
    <div class="file-tabs" id="file-tabs"></div>
    <div style="margin-left:auto;display:flex;gap:7px;">
      <button class="tbtn" style="width:auto;padding:0 12px;" onclick="newScript()">+ New</button>
      <button class="action-btn ab-primary" style="width:auto;padding:7px 14px;margin:0;" onclick="runScript()">â–¶ Run</button>
    </div>
  </div>
  <div class="editor-body">
    <div class="file-tree">
      <div class="ft-title">Scripts</div>
      <div id="file-list"></div>
      <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px;">
        <div class="ft-title">Services</div>
        <div class="ft-item">âš™ï¸ GameService</div>
        <div class="ft-item">ğŸ‘¥ Players</div>
        <div class="ft-item">ğŸŒ Workspace</div>
        <div class="ft-item">ğŸ’¾ DataStore</div>
        <div class="ft-item">ğŸ”— RemoteEvents</div>
        <div class="ft-item">ğŸŒ Network</div>
      </div>
    </div>
    <div class="editor-main">
      <div class="code-wrap">
        <div class="line-nums" id="line-nums">1</div>
        <textarea id="codeEditor" spellcheck="false" oninput="syncLines();autoSave()"></textarea>
      </div>
      <div class="console-pane">
        <div class="console-hdr">
          <span>â¬› Console</span>
          <span id="ws-indicator" style="font-size:11px;color:var(--green);">â— Connected</span>
          <button class="tbtn" style="margin-left:auto;width:auto;padding:0 10px;" onclick="clearConsole()">Clear</button>
        </div>
        <div class="console-out" id="console-out">
          <div class="ci">[BlockVerse] Lua 5.4 engine ready. WebSocket connected.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WS_URL = `ws://${location.host}`;
const COLORS = ['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c','#00e5ff','#ff6b35','#ff3355','#ffd700'];
const BLOCK_TYPES = [
  {id:'grass',  icon:'ğŸŒ¿', color:0x3a7d44, label:'Grass'},
  {id:'stone',  icon:'ğŸª¨', color:0x666688, label:'Stone'},
  {id:'brick',  icon:'ğŸ§±', color:0x8b4513, label:'Brick'},
  {id:'wood',   icon:'ğŸŒ²', color:0x8b6914, label:'Wood'},
  {id:'sand',   icon:'ğŸœï¸', color:0xd4a84b, label:'Sand'},
  {id:'water',  icon:'ğŸ’§', color:0x1a6090, label:'Water'},
  {id:'lava',   icon:'ğŸ”¥', color:0xcc2200, label:'Lava'},
  {id:'ice',    icon:'â„ï¸', color:0xa8d8f0, label:'Ice'},
  {id:'snow',   icon:'â¬œ', color:0xddeeff, label:'Snow'},
  {id:'metal',  icon:'âš™ï¸', color:0x445577, label:'Metal'},
  {id:'glass',  icon:'ğŸ”·', color:0x88ccff, label:'Glass'},
  {id:'leaf',   icon:'ğŸƒ', color:0x228b22, label:'Leaf'},
  {id:'gold',   icon:'âœ¨', color:0xd4af37, label:'Gold'},
  {id:'obsidian',icon:'ğŸŒ‘',color:0x1a0a2e, label:'Obsidian'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ws = null, myId = null, myName = 'Player', myColor = COLORS[0];
let roomId = null, roomName = '';
let remotePlayers = {};   // id â†’ { mesh, nameTag, data }
let localPlayer = { x:0, y:2, z:0, rotY:0, hp:100 };
let keys = {}, joystickDx=0, joystickDy=0, chatFocus=false;
let selectedColor = 0;
let selectedRoom = null;

// 3D Game
let gameRenderer, gameScene, gameCamera, gameMixer;
let blockMeshes = {};          // "x,y,z" â†’ Mesh
let animReq = null;

// Studio
let studioRenderer, studioScene, studioCamera;
let studioBlocks = [];        // {x,y,z,type}
let studioHistory = [];
let studioSelectedBlock = 'grass';
let studioTool = 'place';
let studioAnimReq = null;
let studioMouse = {pressed:false,rightPressed:false,lastX:0,lastY:0};
let studioCamTheta=0.8, studioCamPhi=0.6, studioCamDist=18, studioCamTarget={x:0,y:0,z:0};

// Scripts
const SCRIPTS = [
  {name:'PlayerController.lua', content:`-- Player Controller
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local character = player.Character

local SPEED = 16
local JUMP_POWER = 50

-- Sprint
local UserInputService = game:GetService("UserInputService")
UserInputService.InputBegan:Connect(function(input, proc)
  if proc then return end
  if input.KeyCode == Enum.KeyCode.LeftShift then
    character.Humanoid.WalkSpeed = SPEED * 1.8
    print("Sprint ON for " .. player.Name)
  end
end)

UserInputService.InputEnded:Connect(function(input)
  if input.KeyCode == Enum.KeyCode.LeftShift then
    character.Humanoid.WalkSpeed = SPEED
    print("Sprint OFF")
  end
end)

print("PlayerController loaded! Player: " .. player.Name)
`},
  {name:'GameManager.lua', content:`-- Game Manager
local GameManager = {}

local CONFIG = {
  roundTime = 120,
  minPlayers = 2,
  maxPlayers = 20,
}

function GameManager:startRound()
  if #game.Players:GetPlayers() < CONFIG.minPlayers then
    warn("Not enough players!")
    return
  end
  print("Round started! Duration: " .. CONFIG.roundTime .. "s")
  
  for _, player in ipairs(game.Players:GetPlayers()) do
    player:TeleportToSpawn()
    print("Teleported: " .. player.Name)
  end
end

function GameManager:endRound(winner)
  print("Round over! Winner: " .. (winner or "Nobody"))
  game.Events:FireAllClients("RoundEnd", winner)
end

GameManager:startRound()
`},
  {name:'NetworkEvents.lua', content:`-- Network / Remote Events
local Events = game:GetService("RemoteEvents")
local Players = game:GetService("Players")

-- Handle client events
Events.PlayerAction:Connect(function(player, action, data)
  print(player.Name .. " did: " .. action)
  
  if action == "Attack" then
    local target = data.target
    local dmg = data.damage or 10
    if target then
      target.Character.Humanoid.Health -= dmg
      print("Dealt " .. dmg .. " damage to " .. target.Name)
    end
  end
  
  if action == "UseItem" then
    local item = player.Inventory:GetItem(data.itemId)
    if item then
      item:Use(player)
      print("Used item: " .. item.Name)
    end
  end
end)

-- Broadcast to all
Events.Broadcast:Connect(function(sender, msg)
  for _, p in ipairs(Players:GetPlayers()) do
    Events:FireClient(p, "Message", sender.Name, msg)
  end
end)

print("NetworkEvents initialized!")
`},
];
let currentScriptIdx = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initLobby() {
  // Color swatches
  const row = document.getElementById('color-row');
  COLORS.forEach((c, i) => {
    const s = document.createElement('div');
    s.className = 'color-swatch' + (i===0?' active':'');
    s.style.background = c;
    s.onclick = () => {
      document.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('active'));
      s.classList.add('active');
      myColor = c;
      selectedColor = i;
    };
    row.appendChild(s);
  });

  // Name default
  const saved = localStorage.getItem('bv_name');
  if (saved) document.getElementById('inp-name').value = saved;
}

function connectWS() {
  try {
    ws = new WebSocket(WS_URL);
  } catch(e) {
    setStatus('âš ï¸ Cannot connect to server. Run: node server.js');
    return;
  }

  ws.onopen = () => {
    setStatus('âœ… Connected to BlockVerse Server');
    document.getElementById('btn-join').disabled = false;
    document.getElementById('ws-indicator').textContent = 'â— Connected';
    document.getElementById('ws-indicator').style.color = 'var(--green)';
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    handleMessage(msg);
  };

  ws.onclose = () => {
    setStatus('ğŸ”Œ Disconnected. Reconnecting...');
    document.getElementById('ws-indicator').textContent = 'â— Offline';
    document.getElementById('ws-indicator').style.color = 'var(--red)';
    setTimeout(connectWS, 3000);
  };

  ws.onerror = () => {
    setStatus('âŒ Server unreachable. Start server with: node server.js');
  };
}

function setStatus(txt) {
  const el = document.getElementById('status-bar');
  if(el) el.textContent = txt;
}

function handleMessage(msg) {
  switch(msg.type) {
    case 'welcome':
      myId = msg.playerId;
      renderRoomsList(msg.rooms);
      renderBrowseRooms(msg.rooms);
      break;
    case 'room_joined':
      roomId = msg.roomId;
      roomName = msg.roomName;
      onRoomJoined(msg);
      break;
    case 'player_joined':
      addRemotePlayer(msg.player);
      updatePlayersList();
      showNotif(`${msg.player.name} joined!`, 'ğŸ‘¤');
      break;
    case 'player_left':
      removeRemotePlayer(msg.id);
      updatePlayersList();
      break;
    case 'player_moved':
      moveRemotePlayer(msg);
      break;
    case 'chat':
      appendChat(msg.message);
      break;
    case 'block_update':
      handleBlockUpdate(msg);
      break;
    case 'map_reload':
      rebuildMap(msg.mapData);
      showNotif('Map updated by host!', 'ğŸ—ºï¸');
      break;
    case 'script_output':
      displayScriptOutput(msg.lines);
      break;
    case 'error':
      showNotif(msg.text, 'âš ï¸');
      break;
    case 'info':
      showNotif(msg.text, 'â„¹ï¸');
      break;
    case 'pong':
      // ping/pong
      break;
  }
}

function renderRoomsList(rooms) {
  const c = document.getElementById('rooms-list');
  c.innerHTML = '';
  rooms.forEach(r => {
    const d = document.createElement('div');
    d.className = 'room-item';
    d.innerHTML = `<div>
      <div class="room-name">${r.name}</div>
      <div class="room-count"><div class="dot-online"></div>${r.playerCount}/${r.maxPlayers} players</div>
    </div><div style="font-size:18px;">${['ğŸŒ','âš”ï¸','ğŸ—ï¸','ğŸ™ï¸'][rooms.indexOf(r)]||'ğŸ®'}</div>`;
    d.onclick = () => {
      document.querySelectorAll('.room-item').forEach(x=>x.classList.remove('selected'));
      d.classList.add('selected');
      selectedRoom = r.id;
    };
    c.appendChild(d);
    if(!selectedRoom) { d.classList.add('selected'); selectedRoom = r.id; }
  });
}

function renderBrowseRooms(rooms) {
  const EMOJIS = ['ğŸŒ','âš”ï¸','ğŸ—ï¸','ğŸ™ï¸'];
  const DESCS = [
    'Open sandbox world for everyone to explore and build.',
    'Fast-paced combat arena. Fight for the top spot!',
    'Creative building zone. Show off your creativity.',
    'Roleplay in a living city with jobs and housing.',
  ];
  const c = document.getElementById('browse-rooms-grid');
  c.innerHTML = '';
  rooms.forEach((r, i) => {
    const d = document.createElement('div');
    d.className = 'rcard';
    const BG = ['#0a1a0a','#1a0a0a','#0a0a1a','#0a1015'];
    d.innerHTML = `<div class="rcard-thumb" style="background:${BG[i%4]}">
      ${EMOJIS[i%4]}
      <div class="rcard-pc"><div class="dot-online"></div>${r.playerCount}/${r.maxPlayers}</div>
    </div>
    <div class="rcard-body">
      <div class="rcard-name">${r.name}</div>
      <div class="rcard-desc">${DESCS[i%4]}</div>
      <button class="rcard-join" onclick="joinRoomById('${r.id}','${r.name}')">â–¶ Play Now</button>
    </div>`;
    c.appendChild(d);
  });
}

function joinRoom() {
  myName = document.getElementById('inp-name').value.trim() || 'Player';
  localStorage.setItem('bv_name', myName);
  if(!selectedRoom) { showNotif('Select a room first!','âš ï¸'); return; }
  send({ type:'join_room', roomId:selectedRoom, name:myName, color:myColor });
}

function joinRoomById(id, name) {
  roomId = id;
  send({ type:'join_room', roomId:id, name:myName, color:myColor });
  showPanel('game');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENTER GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onRoomJoined(msg) {
  // Hide lobby
  document.getElementById('screen-lobby').classList.remove('visible');
  document.getElementById('sidebar').style.display = 'flex';

  // Avatar
  const av = document.getElementById('my-avatar');
  av.style.background = myColor;
  av.textContent = myName[0].toUpperCase();

  // HUD
  document.getElementById('hud-room').textContent = msg.roomName.toUpperCase();

  // Init game
  initGame3D(msg.mapData);

  // Add existing players
  Object.values(msg.players).forEach(p => {
    if (p.id !== myId) addRemotePlayer(p);
  });

  // Chat history
  msg.chatHistory.forEach(m => appendChat(m, true));

  // Start game loop
  showPanel('game');
  updatePlayersList();

  // Init studio with server map
  studioBlocks = JSON.parse(JSON.stringify(msg.mapData));
  initStudio3D();
  initScripts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3D GAME ENGINE (Three.js)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGame3D(mapData) {
  const canvas = document.getElementById('gameCanvas');
  gameRenderer = new THREE.WebGLRenderer({ canvas, antialias:true });
  gameRenderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  gameRenderer.shadowMap.enabled = true;
  gameRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
  gameRenderer.setClearColor(0x87ceeb);

  gameScene = new THREE.Scene();
  gameScene.fog = new THREE.FogExp2(0x87ceeb, 0.018);

  // Camera (first-person style, behind player)
  gameCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth/canvas.clientHeight, 0.1, 300);

  // Lights
  const ambient = new THREE.AmbientLight(0xffffff, 0.5);
  gameScene.add(ambient);
  const sun = new THREE.DirectionalLight(0xfff5dd, 1.2);
  sun.position.set(30, 50, 20);
  sun.castShadow = true;
  sun.shadow.mapSize.width = 2048;
  sun.shadow.mapSize.height = 2048;
  sun.shadow.camera.near = 1;
  sun.shadow.camera.far = 200;
  sun.shadow.camera.left = -60;
  sun.shadow.camera.right = 60;
  sun.shadow.camera.top = 60;
  sun.shadow.camera.bottom = -60;
  gameScene.add(sun);

  // Sky sphere
  const skyGeo = new THREE.SphereGeometry(200, 16, 8);
  const skyMat = new THREE.MeshBasicMaterial({
    color: 0x87ceeb, side: THREE.BackSide
  });
  gameScene.add(new THREE.Mesh(skyGeo, skyMat));

  // Build map
  rebuildMap(mapData);

  // My player mesh (capsule-like from cylinder + sphere)
  buildLocalPlayerMesh();

  // Start loop
  cancelAnimationFrame(animReq);
  gameLoop3D();
}

function getBlockColor(type) {
  const t = BLOCK_TYPES.find(b => b.id === type);
  return t ? t.color : 0x888888;
}

function rebuildMap(mapData) {
  // Remove existing block meshes
  Object.values(blockMeshes).forEach(m => gameScene && gameScene.remove(m));
  blockMeshes = {};

  if(!gameScene) return;

  const geo = new THREE.BoxGeometry(1,1,1);
  mapData.forEach(b => {
    const mat = new THREE.MeshLambertMaterial({ color: getBlockColor(b.type) });
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set(b.x + 0.5, b.y + 0.5, b.z + 0.5);
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    gameScene.add(mesh);
    blockMeshes[`${b.x},${b.y},${b.z}`] = mesh;
  });
}

function handleBlockUpdate(msg) {
  const key = `${msg.x},${msg.y},${msg.z}`;
  if(blockMeshes[key]) {
    gameScene.remove(blockMeshes[key]);
    delete blockMeshes[key];
  }
  if(msg.blockType !== 'air') {
    const geo = new THREE.BoxGeometry(1,1,1);
    const mat = new THREE.MeshLambertMaterial({ color: getBlockColor(msg.blockType) });
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set(msg.x+0.5, msg.y+0.5, msg.z+0.5);
    mesh.castShadow = true;
    gameScene.add(mesh);
    blockMeshes[key] = mesh;
  }
}

let myMesh = null;
function buildLocalPlayerMesh() {
  // Use cylinder as body
  const bodyGeo = new THREE.CylinderGeometry(0.3, 0.3, 1.2, 8);
  const bodyMat = new THREE.MeshLambertMaterial({ color: new THREE.Color(myColor) });
  myMesh = new THREE.Mesh(bodyGeo, bodyMat);
  myMesh.castShadow = true;
  gameScene.add(myMesh);
}

// Remote player meshes
function addRemotePlayer(pData) {
  if(pData.id === myId) return;
  if(remotePlayers[pData.id]) return;

  const bodyGeo = new THREE.CylinderGeometry(0.3,0.3,1.2,8);
  const bodyMat = new THREE.MeshLambertMaterial({ color: new THREE.Color(pData.color) });
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.castShadow = true;
  body.position.set(pData.x, pData.y, pData.z);
  gameScene.add(body);

  // Head
  const headGeo = new THREE.BoxGeometry(0.55,0.55,0.55);
  const headMat = new THREE.MeshLambertMaterial({ color: 0xffcc88 });
  const head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 0.87;
  body.add(head);

  // Name label (canvas texture)
  const nameCanvas = document.createElement('canvas');
  nameCanvas.width = 256; nameCanvas.height = 64;
  const nc = nameCanvas.getContext('2d');
  nc.fillStyle = 'rgba(0,0,0,0.7)';
  nc.roundRect(4,4,248,56,8);
  nc.fill();
  nc.fillStyle = pData.color;
  nc.font = 'bold 28px Rajdhani, sans-serif';
  nc.textAlign = 'center';
  nc.fillText(pData.name, 128, 40);
  const tex = new THREE.CanvasTexture(nameCanvas);
  const tagGeo = new THREE.PlaneGeometry(1.4, 0.35);
  const tagMat = new THREE.MeshBasicMaterial({ map:tex, transparent:true, depthWrite:false });
  const tag = new THREE.Mesh(tagGeo, tagMat);
  tag.position.y = 1.5;
  body.add(tag);

  remotePlayers[pData.id] = { mesh:body, data:pData, nameTag:tag };
}

function removeRemotePlayer(id) {
  if(remotePlayers[id]) {
    gameScene.remove(remotePlayers[id].mesh);
    delete remotePlayers[id];
  }
}

function moveRemotePlayer(msg) {
  const rp = remotePlayers[msg.id];
  if(!rp) return;
  rp.mesh.position.set(msg.x, msg.y, msg.z);
  rp.mesh.rotation.y = msg.rotY;
  // Name tag always faces camera
  rp.nameTag && (rp.nameTag.rotation.y = -msg.rotY);
}

// â”€â”€ Physics & movement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SPEED = 6, JUMP_V = 8, GRAV = 20;
let velY = 0, onGround = false;
let camYaw = 0, camPitch = 0;
let pointerLocked = false;

document.addEventListener('click', () => {
  if(document.getElementById('panel-game').classList.contains('visible') && !chatFocus && pointerLockEnabled) {
    document.getElementById('gameCanvas').requestPointerLock();
  }
});
document.addEventListener('pointerlockchange', () => {
  pointerLocked = !!document.pointerLockElement;
  document.getElementById('crosshair').style.display = pointerLocked ? 'block' : 'none';
});
let pointerLockEnabled = true;
function toggleCrosshair() {
  pointerLockEnabled = !pointerLockEnabled;
  if(!pointerLockEnabled && document.pointerLockElement) document.exitPointerLock();
  showNotif(pointerLockEnabled ? 'Aim mode ON â€“ click to lock mouse' : 'Aim mode OFF', 'ğŸ¯');
}
document.addEventListener('mousemove', e => {
  if(!pointerLocked) return;
  camYaw   -= e.movementX * 0.002;
  camPitch -= e.movementY * 0.002;
  camPitch = Math.max(-1.2, Math.min(0.5, camPitch));
  localPlayer.rotY = camYaw;
});

document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if(e.code === 'KeyT' && !chatFocus) {
    e.preventDefault();
    document.getElementById('chat-input').focus();
  }
  if(e.code === 'Escape' && document.pointerLockElement) document.exitPointerLock();
});
document.addEventListener('keyup', e => { keys[e.code] = false; });

document.getElementById('chat-input').addEventListener('focus', () => chatFocus=true);
document.getElementById('chat-input').addEventListener('blur', () => chatFocus=false);

let lastSendTime = 0;

function gameLoop3D() {
  animReq = requestAnimationFrame(gameLoop3D);
  const canvas = document.getElementById('gameCanvas');
  if(!gameRenderer) return;

  // Resize
  const W = canvas.parentElement.clientWidth, H = canvas.parentElement.clientHeight;
  if(gameRenderer.domElement.width !== W || gameRenderer.domElement.height !== H) {
    gameRenderer.setSize(W, H, false);
    gameCamera.aspect = W/H;
    gameCamera.updateProjectionMatrix();
  }

  const dt = 1/60;

  // Movement
  if(!chatFocus) {
    let dx = 0, dz = 0;
    const fwd = new THREE.Vector3(-Math.sin(camYaw), 0, -Math.cos(camYaw));
    const right = new THREE.Vector3(Math.cos(camYaw), 0, -Math.sin(camYaw));

    if(keys['KeyW']||keys['ArrowUp']||joystickDy<-0.3) { dx+=fwd.x; dz+=fwd.z; }
    if(keys['KeyS']||keys['ArrowDown']||joystickDy>0.3) { dx-=fwd.x; dz-=fwd.z; }
    if(keys['KeyA']||keys['ArrowLeft']||joystickDx<-0.3){ dx+=right.x; dz+=right.z; }
    if(keys['KeyD']||keys['ArrowRight']||joystickDx>0.3){ dx-=right.x; dz-=right.z; }

    const spd = (keys['ShiftLeft']||keys['ShiftRight']) ? SPEED*1.8 : SPEED;
    const len = Math.sqrt(dx*dx+dz*dz);
    if(len>0) { dx/=len; dz/=len; }
    localPlayer.x += dx * spd * dt;
    localPlayer.z += dz * spd * dt;

    if((keys['Space']||keys['KeyW']&&onGround) && onGround) {
      velY = JUMP_V; onGround = false;
    }
  }

  // Gravity
  velY -= GRAV * dt;
  localPlayer.y += velY * dt;
  if(localPlayer.y < 2) { localPlayer.y = 2; velY = 0; onGround = true; }

  // Update local player mesh
  if(myMesh) {
    myMesh.position.set(localPlayer.x, localPlayer.y - 0.6, localPlayer.z);
    myMesh.rotation.y = camYaw;
  }

  // Camera (3rd person)
  const dist = 5;
  const cx = localPlayer.x - Math.sin(camYaw)*Math.cos(camPitch)*dist;
  const cy = localPlayer.y + Math.sin(camPitch)*dist + 1;
  const cz = localPlayer.z - Math.cos(camYaw)*Math.cos(camPitch)*dist;
  gameCamera.position.set(cx, cy, cz);
  gameCamera.lookAt(localPlayer.x, localPlayer.y+0.5, localPlayer.z);

  // Name tags face camera
  Object.values(remotePlayers).forEach(rp => {
    if(rp.nameTag) rp.nameTag.lookAt(gameCamera.position);
  });

  // Send position (10/s)
  const now = Date.now();
  if(now - lastSendTime > 100) {
    lastSendTime = now;
    send({ type:'move', x:localPlayer.x, y:localPlayer.y, z:localPlayer.z, rotY:camYaw });
  }

  gameRenderer.render(gameScene, gameCamera);
}

function doJump() {
  if(onGround) { velY = JUMP_V; onGround = false; }
}

// â”€â”€ Block picker HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedBlockType = 'grass';
function initBlockPicker() {
  const c = document.getElementById('block-picker');
  c.innerHTML = '';
  BLOCK_TYPES.slice(0,8).forEach(b => {
    const slot = document.createElement('div');
    slot.className = 'bp-slot' + (b.id===selectedBlockType?' active':'');
    slot.title = b.label;
    slot.innerHTML = b.icon;
    slot.onclick = () => {
      document.querySelectorAll('.bp-slot').forEach(s=>s.classList.remove('active'));
      slot.classList.add('active');
      selectedBlockType = b.id;
    };
    c.appendChild(slot);
  });
}

// Right-click to place/remove block in game view
document.getElementById('gameCanvas').addEventListener('contextmenu', e => e.preventDefault());
document.getElementById('gameCanvas').addEventListener('mousedown', e => {
  if(!document.getElementById('panel-game').classList.contains('visible')) return;
  if(chatFocus) return;
  // Raycast to find block position
  const canvas = document.getElementById('gameCanvas');
  const mouse = new THREE.Vector2(
    (e.clientX / canvas.clientWidth)*2-1,
    -(e.clientY / canvas.clientHeight)*2+1
  );
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, gameCamera);
  const meshList = Object.values(blockMeshes);
  const hits = raycaster.intersectObjects(meshList);
  if(hits.length) {
    const hit = hits[0];
    const pos = hit.point.clone().add(hit.face.normal.clone().multiplyScalar(e.button===2 ? -0.5 : 0.5));
    const bx = Math.floor(pos.x), by = Math.floor(pos.y), bz = Math.floor(pos.z);
    const blockType = e.button===2 ? 'air' : selectedBlockType;
    send({ type:'place_block', x:bx, y:by, z:bz, blockType });
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function appendChat(m, silent=false) {
  const c = document.getElementById('chat-messages');
  const d = document.createElement('div');
  d.className = 'chat-line';
  d.innerHTML = `<span class="chat-sender" style="color:${m.color||'#fff'}">${m.sender}:</span> ${m.text}`;
  c.appendChild(d);
  if(c.children.length > 50) c.removeChild(c.firstChild);
  c.scrollTop = c.scrollHeight;
}

function sendChat(e) {
  if(e) e.preventDefault();
  const inp = document.getElementById('chat-input');
  const txt = inp.value.trim();
  if(!txt) return;
  send({ type:'chat', text:txt });
  inp.value = '';
  inp.blur();
  chatFocus = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYERS LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePlayersList() {
  const c = document.getElementById('pp-list');
  c.innerHTML = `<div class="pp-player"><div class="pp-dot" style="background:${myColor};box-shadow:0 0 5px ${myColor}"></div>${myName} (you)</div>`;
  Object.values(remotePlayers).forEach(rp => {
    c.innerHTML += `<div class="pp-player"><div class="pp-dot" style="background:${rp.data.color}"></div>${rp.data.name}</div>`;
  });
  const total = Object.keys(remotePlayers).length + 1;
  document.getElementById('hud-pcount').textContent = `${total} Player${total!==1?'s':''}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDIO (3D editor)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initStudio3D() {
  const canvas = document.getElementById('studioCanvas');
  if(studioRenderer) { studioRenderer.dispose(); cancelAnimationFrame(studioAnimReq); }
  studioRenderer = new THREE.WebGLRenderer({ canvas, antialias:true });
  studioRenderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  studioRenderer.shadowMap.enabled = true;
  studioRenderer.setClearColor(0x0a0a1a);

  studioScene = new THREE.Scene();
  studioCamera = new THREE.PerspectiveCamera(65, canvas.clientWidth/canvas.clientHeight, 0.1, 200);

  // Lights
  studioScene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dLight = new THREE.DirectionalLight(0xffffff, 0.9);
  dLight.position.set(20, 30, 15);
  studioScene.add(dLight);

  // Grid
  const grid = new THREE.GridHelper(80, 80, 0x222244, 0x1a1a33);
  studioScene.add(grid);

  // Block palette
  const bg = document.getElementById('studio-block-grid');
  bg.innerHTML = '';
  BLOCK_TYPES.forEach(b => {
    const btn = document.createElement('div');
    btn.className = 'block-btn' + (b.id===studioSelectedBlock?' sel':'');
    btn.id = 'sblk-'+b.id;
    btn.innerHTML = `<span class="block-icon">${b.icon}</span><div class="block-label">${b.label}</div>`;
    btn.onclick = () => {
      document.querySelectorAll('.block-btn').forEach(x=>x.classList.remove('sel'));
      btn.classList.add('sel');
      studioSelectedBlock = b.id;
    };
    bg.appendChild(btn);
  });

  rebuildStudioBlocks();
  studioLoop();
  initStudioControls();
}

let studioMeshes = {};
function rebuildStudioBlocks() {
  Object.values(studioMeshes).forEach(m => studioScene.remove(m));
  studioMeshes = {};
  const geo = new THREE.BoxGeometry(1,1,1);
  studioBlocks.forEach(b => {
    const mat = new THREE.MeshLambertMaterial({ color: getBlockColor(b.type) });
    const m = new THREE.Mesh(geo, mat);
    m.position.set(b.x+0.5, b.y+0.5, b.z+0.5);
    m.castShadow = true;
    studioScene.add(m);
    studioMeshes[`${b.x},${b.y},${b.z}`] = m;
  });
}

function studioLoop() {
  studioAnimReq = requestAnimationFrame(studioLoop);
  const canvas = document.getElementById('studioCanvas');
  const W = canvas.parentElement.clientWidth, H = canvas.parentElement.clientHeight;
  if(studioRenderer.domElement.width!==W||studioRenderer.domElement.height!==H) {
    studioRenderer.setSize(W,H,false);
    studioCamera.aspect = W/H;
    studioCamera.updateProjectionMatrix();
  }
  // Orbit camera
  const cx = studioCamTarget.x + studioCamDist*Math.sin(studioCamTheta)*Math.cos(studioCamPhi);
  const cy = studioCamTarget.y + studioCamDist*Math.sin(studioCamPhi);
  const cz = studioCamTarget.z + studioCamDist*Math.cos(studioCamTheta)*Math.cos(studioCamPhi);
  studioCamera.position.set(cx,cy,cz);
  studioCamera.lookAt(studioCamTarget.x, studioCamTarget.y, studioCamTarget.z);
  studioRenderer.render(studioScene, studioCamera);
}

function initStudioControls() {
  const canvas = document.getElementById('studioCanvas');
  let orbitDragging = false;
  let orbLastX=0, orbLastY=0;

  canvas.addEventListener('mousedown', e => {
    if(e.button===1||e.button===2) { orbitDragging=true; orbLastX=e.clientX; orbLastY=e.clientY; e.preventDefault(); return; }
    if(e.button===0) studioRaycast(e, studioTool);
  });
  window.addEventListener('mousemove', e => {
    if(!orbitDragging) return;
    const dx = e.clientX-orbLastX, dy = e.clientY-orbLastY;
    orbLastX=e.clientX; orbLastY=e.clientY;
    studioCamTheta -= dx*0.008;
    studioCamPhi   = Math.max(-1.4,Math.min(1.4,studioCamPhi-dy*0.008));
  });
  window.addEventListener('mouseup', e => { if(e.button===1||e.button===2) orbitDragging=false; });
  canvas.addEventListener('contextmenu', e => e.preventDefault());
  canvas.addEventListener('wheel', e => {
    studioCamDist = Math.max(3, Math.min(60, studioCamDist + e.deltaY*0.02));
  });

  // Touch orbit
  let touches={};
  canvas.addEventListener('touchstart', e=>{
    [...e.touches].forEach(t => touches[t.identifier]={x:t.clientX,y:t.clientY});
    e.preventDefault();
  },{passive:false});
  canvas.addEventListener('touchmove', e=>{
    const t = e.touches[0];
    const prev = touches[t.identifier]||{x:t.clientX,y:t.clientY};
    const dx=t.clientX-prev.x, dy=t.clientY-prev.y;
    studioCamTheta-=dx*0.008;
    studioCamPhi=Math.max(-1.4,Math.min(1.4,studioCamPhi-dy*0.008));
    [...e.touches].forEach(tt=>touches[tt.identifier]={x:tt.clientX,y:tt.clientY});
    e.preventDefault();
  },{passive:false});
}

function studioRaycast(e, tool) {
  const canvas = document.getElementById('studioCanvas');
  const rect = canvas.getBoundingClientRect();
  const mouse = new THREE.Vector2(
    ((e.clientX-rect.left)/rect.width)*2-1,
    -((e.clientY-rect.top)/rect.height)*2+1
  );
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, studioCamera);
  const hits = raycaster.intersectObjects(Object.values(studioMeshes));
  if(hits.length) {
    const hit = hits[0];
    if(tool==='erase') {
      const pos = hit.object.position.clone().subScalar(0.5);
      const key = `${Math.round(pos.x)},${Math.round(pos.y)},${Math.round(pos.z)}`;
      studioHistory.push(JSON.parse(JSON.stringify(studioBlocks)));
      studioBlocks = studioBlocks.filter(b=>!(`${b.x},${b.y},${b.z}`===key));
      if(studioMeshes[key]) { studioScene.remove(studioMeshes[key]); delete studioMeshes[key]; }
    } else if(tool==='pick') {
      // detect type from position
      const pos = hit.object.position.clone().subScalar(0.5);
      const bx=Math.round(pos.x), by=Math.round(pos.y), bz=Math.round(pos.z);
      const found = studioBlocks.find(b=>b.x===bx&&b.y===by&&b.z===bz);
      if(found) { studioSelectedBlock=found.type; document.querySelectorAll('.block-btn').forEach(x=>x.classList.remove('sel')); document.getElementById('sblk-'+found.type)?.classList.add('sel'); }
    } else {
      // place
      const norm = hit.face.normal;
      const pos = hit.object.position.clone().addScaledVector(norm,1);
      const bx=Math.round(pos.x-0.5), by=Math.round(pos.y-0.5), bz=Math.round(pos.z-0.5);
      const key=`${bx},${by},${bz}`;
      studioHistory.push(JSON.parse(JSON.stringify(studioBlocks)));
      studioBlocks=studioBlocks.filter(b=>!(b.x===bx&&b.y===by&&b.z===bz));
      studioBlocks.push({x:bx,y:by,z:bz,type:studioSelectedBlock});
      const geo=new THREE.BoxGeometry(1,1,1);
      const mat=new THREE.MeshLambertMaterial({color:getBlockColor(studioSelectedBlock)});
      const m=new THREE.Mesh(geo,mat);
      m.position.set(bx+0.5,by+0.5,bz+0.5);
      m.castShadow=true;
      if(studioMeshes[key]) studioScene.remove(studioMeshes[key]);
      studioScene.add(m);
      studioMeshes[key]=m;
    }
  } else {
    // Click on ground plane
    if(tool==='place') {
      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(mouse, studioCamera);
      const plane = new THREE.Plane(new THREE.Vector3(0,1,0), 0);
      const pt = new THREE.Vector3();
      raycaster.ray.intersectPlane(plane, pt);
      if(pt) {
        const bx=Math.floor(pt.x), bz=Math.floor(pt.z), by=0;
        const key=`${bx},${by},${bz}`;
        studioHistory.push(JSON.parse(JSON.stringify(studioBlocks)));
        studioBlocks=studioBlocks.filter(b=>!(b.x===bx&&b.y===by&&b.z===bz));
        studioBlocks.push({x:bx,y:by,z:bz,type:studioSelectedBlock});
        const geo=new THREE.BoxGeometry(1,1,1);
        const mat=new THREE.MeshLambertMaterial({color:getBlockColor(studioSelectedBlock)});
        const m=new THREE.Mesh(geo,mat);
        m.position.set(bx+0.5,by+0.5,bz+0.5);
        m.castShadow=true;
        if(studioMeshes[key]) studioScene.remove(studioMeshes[key]);
        studioScene.add(m);
        studioMeshes[key]=m;
      }
    }
  }
}

function setStudioTool(t) {
  studioTool=t;
  document.querySelectorAll('.tbtn[id^="stbtn-"]').forEach(b=>b.classList.remove('active'));
  document.getElementById('stbtn-'+t)?.classList.add('active');
}
function undoStudio() { if(studioHistory.length){studioBlocks=studioHistory.pop();rebuildStudioBlocks();showNotif('Undone!','â†©ï¸');}}
function clearStudio() { studioHistory.push(JSON.parse(JSON.stringify(studioBlocks))); studioBlocks=[]; rebuildStudioBlocks(); showNotif('Cleared!','ğŸ—‘ï¸'); }
function updateStudioSky() {
  const sky = document.getElementById('map-sky').value;
  const colors = {day:0x87ceeb,night:0x05050f,dusk:0x3a1c2c,space:0x000005};
  studioRenderer.setClearColor(colors[sky]||0x87ceeb);
}
function applyStudioMap() {
  if(!ws||ws.readyState!==1) { showNotif('Not connected!','âš ï¸'); return; }
  send({ type:'save_map', mapData:studioBlocks });
  rebuildMap(studioBlocks);
  showNotif('Map pushed to server & synced to all players!','ğŸ“¤');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCRIPT EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initScripts() {
  const fl = document.getElementById('file-list');
  const tabs = document.getElementById('file-tabs');
  fl.innerHTML=''; tabs.innerHTML='';
  SCRIPTS.forEach((s,i) => {
    const fi=document.createElement('div');
    fi.className='ft-item'+(i===0?' active':'');
    fi.id='fi-'+i;
    fi.innerHTML=`<span>ğŸ“œ</span>${s.name}`;
    fi.onclick=()=>loadScript(i);
    fl.appendChild(fi);
    const tab=document.createElement('div');
    tab.className='ftab'+(i===0?' active':'');
    tab.id='ftab-'+i;
    tab.textContent=s.name.replace('.lua','');
    tab.onclick=()=>loadScript(i);
    tabs.appendChild(tab);
  });
  loadScript(0);
}

function loadScript(i) {
  currentScriptIdx=i;
  document.querySelectorAll('.ft-item').forEach((el,idx)=>el.classList.toggle('active',idx===i));
  document.querySelectorAll('.ftab').forEach((el,idx)=>el.classList.toggle('active',idx===i));
  document.getElementById('codeEditor').value=SCRIPTS[i].content;
  syncLines();
}

function syncLines() {
  const lines=document.getElementById('codeEditor').value.split('\n').length;
  document.getElementById('line-nums').innerHTML=Array.from({length:lines},(_,i)=>i+1).join('<br>');
}
function autoSave() { SCRIPTS[currentScriptIdx].content=document.getElementById('codeEditor').value; }

function newScript() {
  const name=prompt('Script name:','MyScript');
  if(!name) return;
  SCRIPTS.push({name:name+'.lua',content:`-- ${name}\nprint("${name} loaded!")\n`});
  initScripts();
  loadScript(SCRIPTS.length-1);
}

function runScript() {
  const code=document.getElementById('codeEditor').value;
  logConsole(`[Run] Executing ${SCRIPTS[currentScriptIdx].name}...`,'ci');
  if(ws&&ws.readyState===1) {
    send({ type:'script_run', code });
  } else {
    // Local fallback
    displayScriptOutput(simulateLuaLocal(code));
  }
}

function simulateLuaLocal(code) {
  const lines=[];
  (code.match(/print\(([^)]+)\)/g)||[]).forEach(p=>{
    lines.push({level:'log',text:p.slice(6,-1).replace(/['"]/g,'').replace('player.Name',myName)});
  });
  if(!lines.length) lines.push({level:'info',text:'Script executed (no output)'});
  lines.push({level:'success',text:`Done in ${(Math.random()*30+5).toFixed(1)}ms`});
  return lines;
}

function displayScriptOutput(lines) {
  lines.forEach(l => {
    const cls = l.level==='error'?'ce':l.level==='success'?'cs':l.level==='info'?'ci':'cl';
    logConsole(l.text, cls);
  });
}

function logConsole(text,cls='cl') {
  const c=document.getElementById('console-out');
  const d=document.createElement('div');
  d.className=cls; d.textContent=text;
  c.appendChild(d);
  if(c.children.length>100) c.removeChild(c.firstChild);
  c.scrollTop=c.scrollHeight;
}
function clearConsole() { document.getElementById('console-out').innerHTML='<div class="ci">[BlockVerse] Console cleared.</div>'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOYSTICK (mobile)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initJoystick() {
  const base=document.getElementById('joy-base');
  const stick=document.getElementById('joy-stick');
  const MAX=34;
  let tid=null, sx,sy;

  base.addEventListener('touchstart',e=>{
    const t=e.touches[0];
    const r=base.getBoundingClientRect();
    sx=r.left+r.width/2; sy=r.top+r.height/2;
    tid=t.identifier;
    e.preventDefault();
  },{passive:false});
  base.addEventListener('touchmove',e=>{
    const t=[...e.touches].find(t=>t.identifier===tid);
    if(!t) return;
    const dx=t.clientX-sx,dy=t.clientY-sy;
    const d=Math.sqrt(dx*dx+dy*dy);
    const c=Math.min(d,MAX);
    const a=Math.atan2(dy,dx);
    const nx=Math.cos(a)*c,ny=Math.sin(a)*c;
    stick.style.transform=`translate(${nx}px,${ny}px)`;
    joystickDx=nx/MAX; joystickDy=ny/MAX;
    e.preventDefault();
  },{passive:false});
  const end=()=>{stick.style.transform='';joystickDx=0;joystickDy=0;};
  base.addEventListener('touchend',end);
  base.addEventListener('touchcancel',end);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PANEL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('visible'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('visible');
  document.getElementById('nav-'+name)?.classList.add('active');
  if(name==='game') {
    initBlockPicker();
    updatePlayersList();
  }
  if(name==='studio' && !studioRenderer) initStudio3D();
}

function leaveGame() {
  gameRunning=false;
  cancelAnimationFrame(animReq);
  if(document.pointerLockElement) document.exitPointerLock();
  // Back to lobby
  document.getElementById('sidebar').style.display='none';
  document.getElementById('screen-lobby').classList.add('visible');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('visible'));
  if(ws&&ws.readyState===1) ws.close();
  remotePlayers={};
  showNotif('Left the world. See you next time!','ğŸ‘‹');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function send(msg) {
  if(ws&&ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(msg));
}

function showNotif(msg, icon='âœ…') {
  document.querySelectorAll('.notif').forEach(n=>n.remove());
  const n=document.createElement('div');
  n.className='notif';
  n.innerHTML=`${icon} ${msg}`;
  document.body.appendChild(n);
  setTimeout(()=>n.remove(),2800);
}

// Handle window resize for game canvas
window.addEventListener('resize',()=>{
  if(gameRenderer) {
    const c=document.getElementById('gameCanvas');
    const W=c.parentElement.clientWidth,H=c.parentElement.clientHeight;
    gameRenderer.setSize(W,H,false);
    gameCamera.aspect=W/H; gameCamera.updateProjectionMatrix();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initLobby();
initJoystick();
connectWS();
</script>
</body>
</html>
