<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>BlockVerse 3D</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#07070f;--bg2:#0d0d1a;--bg3:#13131f;--card:#16162a;--border:#1e1e38;
--cyan:#00e5ff;--cyan2:#00b8d4;--orange:#ff6b35;--green:#39ff14;--red:#ff3355;
--gold:#ffd700;--purple:#a855f7;--muted:#5a5a88;--text:#ddddf8;
--font:'Rajdhani',sans-serif;--mono:'Fira Code',monospace;--pixel:'Press Start 2P',monospace}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:var(--font)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.screen{position:fixed;inset:0;display:none;z-index:20}
.screen.visible{display:flex}
/* LOBBY */
#screen-lobby{flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 30% 60%,rgba(168,85,247,.2),transparent 60%),
  radial-gradient(ellipse at 70% 20%,rgba(0,229,255,.16),transparent 55%),var(--bg)}
.lobby-bg{position:fixed;inset:0;pointer-events:none;
  background-image:linear-gradient(rgba(0,229,255,.04) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,229,255,.04) 1px,transparent 1px);background-size:48px 48px}
.logo{font-family:var(--pixel);font-size:clamp(14px,4vw,30px);color:var(--cyan);
  text-shadow:0 0 30px rgba(0,229,255,.6);margin-bottom:6px;letter-spacing:3px}
.logo-sub{font-size:clamp(10px,2vw,13px);color:var(--muted);margin-bottom:26px;font-weight:600}
.join-card{background:rgba(13,13,26,.97);border:1px solid var(--border);border-radius:20px;
  padding:22px;width:min(410px,94vw);backdrop-filter:blur(12px);position:relative;z-index:1}
.lbl{display:block;font-size:10px;color:var(--muted);font-weight:700;margin-bottom:4px;text-transform:uppercase;letter-spacing:1px}
.inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;
  padding:9px 12px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;transition:.2s}
.inp:focus{border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,229,255,.1)}
.ig{margin-bottom:11px}
.color-row{display:flex;gap:5px;flex-wrap:wrap}
.cswatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:.14s}
.cswatch.active{border-color:#fff;transform:scale(1.22)}
.rooms-list{display:flex;flex-direction:column;gap:5px;max-height:150px;overflow-y:auto;margin-bottom:11px}
.room-item{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 11px;
  cursor:pointer;transition:.14s;display:flex;align-items:center;justify-content:space-between}
.room-item:hover,.room-item.selected{border-color:var(--cyan);background:rgba(0,229,255,.06)}
.room-name{font-weight:700;font-size:13px}
.room-count{font-size:10px;color:var(--muted);display:flex;align-items:center;gap:4px}
.dot-on{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green)}
.btn-join{width:100%;padding:11px;border-radius:10px;border:none;
  background:linear-gradient(135deg,var(--cyan),var(--cyan2));color:#000;
  font-family:var(--font);font-size:14px;font-weight:700;cursor:pointer;transition:.2s}
.btn-join:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,229,255,.4)}
.btn-join:disabled{opacity:.4;cursor:not-allowed;transform:none}
#status-bar{font-size:10px;color:var(--muted);text-align:center;margin-top:7px;min-height:15px}
/* SIDEBAR */
#sidebar{position:fixed;left:0;top:0;bottom:0;width:52px;background:rgba(7,7,15,.97);
  border-right:1px solid var(--border);display:none;flex-direction:column;align-items:center;
  padding:7px 0;gap:2px;z-index:100;backdrop-filter:blur(14px)}
.logo-icon{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--cyan),var(--purple));
  display:flex;align-items:center;justify-content:center;margin-bottom:9px;
  font-family:var(--pixel);font-size:10px;color:#fff;cursor:pointer}
.nav-item{width:39px;height:39px;border-radius:8px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--muted);font-size:16px;transition:.14s;position:relative;border:1px solid transparent}
.nav-item:hover{background:var(--bg3);color:var(--text)}
.nav-item.active{background:rgba(0,229,255,.13);color:var(--cyan);border-color:rgba(0,229,255,.22)}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);
  width:3px;height:17px;background:var(--cyan);border-radius:0 3px 3px 0}
.nav-tt{position:absolute;left:48px;background:var(--bg2);border:1px solid var(--border);
  color:var(--text);padding:4px 8px;border-radius:6px;font-size:11px;white-space:nowrap;
  pointer-events:none;opacity:0;transition:.12s;z-index:999;font-weight:700}
.nav-item:hover .nav-tt{opacity:1}
.sb-bot{margin-top:auto;display:flex;flex-direction:column;align-items:center;gap:5px}
.av-orb{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:12px;color:#fff;cursor:pointer;border:2px solid transparent}
/* PANELS */
.panel{position:fixed;left:52px;top:0;right:0;bottom:0;display:none;flex-direction:column}
.panel.visible{display:flex}
/* GAME */
#panel-game{background:#000}
#gameCanvas{display:block;width:100%;height:100%;cursor:crosshair}
#hud{position:fixed;top:0;left:52px;right:0;z-index:50;pointer-events:none;
  background:linear-gradient(180deg,rgba(7,7,15,.88),transparent);
  padding:8px 11px;display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.hud-room{font-family:var(--pixel);font-size:7px;color:var(--cyan)}
.hud-pct{font-size:11px;font-weight:700;display:flex;align-items:center;gap:4px}
.hud-r{display:flex;align-items:center;gap:6px;margin-left:auto;pointer-events:all}
.hud-coins{font-family:var(--pixel);font-size:7px;color:var(--gold);display:flex;align-items:center;gap:4px}
.hp-wrap{display:flex;align-items:center;gap:5px}
.hp-bar{width:78px;height:5px;background:var(--bg3);border-radius:3px;overflow:hidden}
.hp-fill{height:100%;background:linear-gradient(90deg,var(--red),var(--orange),var(--green));border-radius:3px;transition:.3s}
.hbtn{padding:4px 9px;border-radius:6px;font-family:var(--font);font-size:11px;font-weight:700;cursor:pointer;border:1px solid}
.hbtn-r{background:rgba(255,51,85,.12);border-color:rgba(255,51,85,.3);color:var(--red)}
.hbtn-g{background:rgba(255,255,255,.05);border-color:var(--border);color:var(--muted)}
#cam-hint{position:fixed;top:46px;left:50%;transform:translateX(-50%);
  background:rgba(0,229,255,.12);border:1px solid rgba(0,229,255,.3);color:var(--cyan);
  padding:5px 13px;border-radius:17px;font-size:11px;font-weight:700;z-index:55;pointer-events:none;transition:opacity .5s}
#crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:60;display:none}
#crosshair::before,#crosshair::after{content:'';position:absolute;background:rgba(255,255,255,.85);border-radius:1px}
#crosshair::before{width:14px;height:2px;top:-1px;left:-7px}
#crosshair::after{width:2px;height:14px;top:-7px;left:-1px}
#pp{position:fixed;top:49px;right:9px;background:rgba(7,7,15,.88);border:1px solid var(--border);
  border-radius:10px;padding:9px;width:138px;z-index:50;backdrop-filter:blur(8px)}
.pp-t{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
.pp-row{display:flex;align-items:center;gap:5px;margin-bottom:3px;font-size:12px;font-weight:600}
.pp-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
#chat-wrap{position:fixed;bottom:9px;left:64px;width:255px;z-index:50}
#chat-msgs{background:rgba(7,7,15,.85);border:1px solid var(--border);border-radius:10px 10px 0 0;
  height:98px;overflow-y:auto;padding:7px 9px;font-size:11px;line-height:1.8;backdrop-filter:blur(8px)}
.chat-line{margin-bottom:1px}
.chat-sn{font-weight:700}
#chat-form{display:flex}
#chat-inp{flex:1;background:rgba(7,7,15,.9);border:1px solid var(--border);border-right:none;border-top:none;
  border-radius:0 0 0 10px;padding:6px 9px;color:var(--text);font-family:var(--font);font-size:12px;outline:none}
#chat-send{background:var(--cyan);color:#000;border:none;padding:6px 10px;border-radius:0 0 10px 0;cursor:pointer;font-weight:700}
#bpicker{position:fixed;bottom:9px;left:50%;transform:translateX(-50%);
  background:rgba(7,7,15,.92);border:1px solid var(--border);border-radius:10px;
  padding:5px 6px;display:flex;gap:4px;z-index:50;backdrop-filter:blur(8px)}
.bp-slot{width:37px;height:37px;border-radius:6px;border:2px solid var(--border);
  cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;
  transition:.12s;flex-direction:column;gap:1px}
.bp-slot:hover,.bp-slot.active{border-color:var(--cyan);background:rgba(0,229,255,.1)}
.bp-num{font-size:7px;color:var(--muted);font-family:var(--mono)}
#joy-wrap{position:fixed;bottom:80px;right:13px;z-index:60;touch-action:none;display:none}
.joy-base{width:84px;height:84px;border-radius:50%;background:rgba(255,255,255,.07);
  border:2px solid rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;touch-action:none}
.joy-stick{width:33px;height:33px;border-radius:50%;background:rgba(0,229,255,.5);
  border:2px solid var(--cyan);position:absolute;pointer-events:none}
#mob-jump{position:fixed;bottom:152px;right:16px;z-index:60;width:48px;height:48px;border-radius:50%;
  background:rgba(255,107,53,.7);border:2px solid var(--orange);display:none;align-items:center;
  justify-content:center;font-size:19px;cursor:pointer;touch-action:none}
#mob-cam{position:fixed;top:47px;left:52px;right:0;bottom:0;z-index:45;display:none;touch-action:none}
/* BROWSE */
#panel-browse{background:var(--bg);overflow-y:auto;padding:16px}
.p-title{font-family:var(--pixel);font-size:8px;color:var(--cyan);margin-bottom:13px}
.rooms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:11px}
.rcard{background:var(--card);border:1px solid var(--border);border-radius:13px;overflow:hidden;cursor:pointer;transition:.2s}
.rcard:hover{transform:translateY(-3px);border-color:var(--cyan);box-shadow:0 7px 24px rgba(0,229,255,.13)}
.rcard-thumb{height:96px;display:flex;align-items:center;justify-content:center;font-size:44px;position:relative}
.rcard-pc{position:absolute;bottom:5px;right:5px;background:rgba(0,0,0,.7);border-radius:14px;
  padding:2px 7px;font-size:10px;color:var(--green);font-weight:700;display:flex;align-items:center;gap:3px}
.rcard-body{padding:9px}
.rcard-name{font-size:13px;font-weight:700;margin-bottom:3px}
.rcard-desc{font-size:11px;color:var(--muted);margin-bottom:8px;line-height:1.4}
.rcard-join{width:100%;padding:7px;border-radius:7px;border:none;
  background:linear-gradient(135deg,var(--cyan),var(--cyan2));color:#000;
  font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer}
/* MARKETPLACE */
#panel-market{background:var(--bg);overflow:hidden}
.mkt-hdr{background:var(--bg2);border-bottom:1px solid var(--border);
  padding:10px 14px;display:flex;align-items:center;gap:9px;flex-shrink:0;flex-wrap:wrap}
.mkt-title{font-family:var(--pixel);font-size:8px;color:var(--gold)}
.mkt-bal{font-family:var(--pixel);font-size:7px;color:var(--gold);display:flex;align-items:center;gap:4px;margin-left:auto}
.mkt-cats{display:flex;gap:4px;overflow-x:auto;padding-bottom:1px}
.mcat{padding:5px 11px;border-radius:15px;border:1px solid var(--border);background:transparent;
  color:var(--muted);cursor:pointer;font-family:var(--font);font-size:12px;font-weight:700;transition:.13s;white-space:nowrap}
.mcat:hover,.mcat.active{background:rgba(255,215,0,.1);border-color:var(--gold);color:var(--gold)}
.mkt-body{flex:1;overflow-y:auto;padding:13px}
.mkt-search{display:flex;align-items:center;gap:7px;background:var(--bg3);border:1px solid var(--border);
  border-radius:8px;padding:7px 11px;margin-bottom:13px;max-width:330px}
.mkt-search input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:13px}
.items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:10px}
.icard{background:var(--card);border:1px solid var(--border);border-radius:11px;overflow:hidden;transition:.16s}
.icard:hover{border-color:var(--gold);transform:translateY(-3px);box-shadow:0 5px 18px rgba(255,215,0,.11)}
.ithumb{height:88px;display:flex;align-items:center;justify-content:center;font-size:40px;position:relative;background:var(--bg3)}
.irarity{position:absolute;top:5px;right:5px;font-size:8px;font-weight:700;padding:2px 5px;border-radius:7px}
.r-common{background:rgba(150,150,150,.2);color:#aaa;border:1px solid #555}
.r-rare{background:rgba(52,152,219,.2);color:#5dade2;border:1px solid #2980b9}
.r-epic{background:rgba(155,89,182,.2);color:var(--purple);border:1px solid #8e44ad}
.r-legendary{background:rgba(255,215,0,.2);color:var(--gold);border:1px solid #b8860b}
.ibody{padding:8px}
.iname{font-size:12px;font-weight:700;margin-bottom:2px}
.idesc{font-size:10px;color:var(--muted);margin-bottom:6px;line-height:1.4}
.iprice{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:3px}
.icost{font-family:var(--pixel);font-size:7px;color:var(--gold)}
.iowned{font-size:10px;color:var(--green);font-weight:700}
.btn-buy{background:linear-gradient(135deg,var(--gold),#b8860b);color:#000;border:none;
  padding:4px 8px;border-radius:5px;font-family:var(--font);font-size:10px;font-weight:700;cursor:pointer}
.btn-buy:disabled{opacity:.4;cursor:not-allowed}
.btn-equip{background:rgba(0,229,255,.1);color:var(--cyan);border:1px solid rgba(0,229,255,.3);
  padding:4px 7px;border-radius:5px;font-family:var(--font);font-size:10px;font-weight:700;cursor:pointer}
.btn-equip.equipped{background:rgba(57,255,20,.1);color:var(--green);border-color:rgba(57,255,20,.3)}
.btn-sell{background:rgba(255,51,85,.07);color:var(--red);border:1px solid rgba(255,51,85,.2);
  padding:4px 6px;border-radius:5px;font-family:var(--font);font-size:10px;font-weight:700;cursor:pointer}
/* AVATAR */
#panel-avatar{background:var(--bg);overflow:hidden}
.av-hdr{background:var(--bg2);border-bottom:1px solid var(--border);
  padding:9px 13px;display:flex;align-items:center;gap:9px;flex-shrink:0}
.av-title{font-family:var(--pixel);font-size:7px;color:var(--purple)}
.av-body{flex:1;display:flex;overflow:hidden}
.av-left{width:200px;min-width:200px;background:var(--bg2);border-right:1px solid var(--border);
  padding:10px;overflow-y:auto;display:flex;flex-direction:column;gap:9px}
.av-sec{border:1px solid var(--border);border-radius:10px;overflow:hidden}
.av-sec-ttl{padding:7px 10px;background:var(--bg3);font-size:9px;font-weight:700;
  text-transform:uppercase;letter-spacing:1px;color:var(--muted)}
.av-sec-body{padding:8px 10px}
.av-colors{display:flex;gap:5px;flex-wrap:wrap}
.av-col{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:.12s}
.av-col.active{border-color:#fff;transform:scale(1.22)}
.av-acc-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px}
.av-acc{padding:5px 2px;border-radius:6px;border:1px solid var(--border);cursor:pointer;
  text-align:center;background:var(--bg3);transition:.12s;font-size:15px}
.av-acc:hover{border-color:var(--muted)}
.av-acc.equipped{border-color:var(--purple);background:rgba(168,85,247,.1)}
.av-acc.locked{opacity:.33;cursor:not-allowed}
.av-acc span{display:block;font-size:8px;color:var(--muted);margin-top:2px}
.av-preview{flex:1;position:relative;overflow:hidden}
#avatarCanvas{display:block;width:100%;height:100%}
.av-info{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);
  background:rgba(7,7,15,.85);border:1px solid var(--border);border-radius:7px;
  padding:5px 11px;font-size:10px;color:var(--muted);text-align:center;white-space:nowrap}
.av-right{width:153px;min-width:153px;background:var(--bg2);border-left:1px solid var(--border);padding:10px;overflow-y:auto}
.ar-ttl{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:7px}
.ar-stat{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:11px}
.ar-val{font-weight:700;color:var(--cyan)}
.ar-actions{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.ar-btn{width:100%;padding:7px;border-radius:7px;border:none;cursor:pointer;font-family:var(--font);font-size:11px;font-weight:700;transition:.14s}
.ar-save{background:linear-gradient(135deg,var(--purple),#7c3aed);color:#fff}
.ar-save:hover{box-shadow:0 3px 10px rgba(168,85,247,.4)}
.ar-reset{background:rgba(255,51,85,.08);color:var(--red);border:1px solid rgba(255,51,85,.2)}
/* STUDIO */
#panel-studio{background:var(--bg);overflow:hidden}
.std-hdr{background:var(--bg2);border-bottom:1px solid var(--border);
  padding:7px 11px;display:flex;align-items:center;gap:6px;flex-shrink:0;flex-wrap:wrap}
.std-ttl{font-family:var(--pixel);font-size:7px;color:var(--cyan);margin-right:4px}
.tgrp{display:flex;gap:2px;padding-right:6px;border-right:1px solid var(--border)}
.tbtn{width:30px;height:30px;border-radius:6px;border:1px solid transparent;background:transparent;
  color:var(--muted);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:.11s}
.tbtn:hover{background:var(--bg3);color:var(--text)}
.tbtn.active{background:rgba(0,229,255,.12);border-color:rgba(0,229,255,.3);color:var(--cyan)}
.std-body{flex:1;display:flex;overflow:hidden}
.std-sb{width:148px;min-width:148px;background:var(--bg2);border-right:1px solid var(--border);padding:8px;overflow-y:auto}
.s-ttl{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px}
.blk-grid{display:grid;grid-template-columns:1fr 1fr;gap:3px}
.blk-btn{padding:5px 2px;border-radius:6px;border:1px solid var(--border);cursor:pointer;
  text-align:center;background:var(--bg3);transition:.11s}
.blk-btn:hover,.blk-btn.sel{border-color:var(--cyan);background:rgba(0,229,255,.07)}
.blk-icon{font-size:16px;display:block;margin-bottom:2px}
.blk-lbl{font-size:8px;color:var(--muted);font-weight:700}
.std-3d{flex:1;position:relative;overflow:hidden}
#studioCanvas{display:block;width:100%;height:100%}
.std-info{position:absolute;bottom:7px;left:7px;background:rgba(7,7,15,.8);
  border:1px solid var(--border);border-radius:7px;padding:5px 9px;font-size:9px;color:var(--muted)}
.std-rt{width:140px;min-width:140px;background:var(--bg2);border-left:1px solid var(--border);padding:8px;overflow-y:auto}
.prop-lbl{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-bottom:2px;display:block}
.prop-inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:5px;
  padding:5px 7px;color:var(--text);font-family:var(--font);font-size:12px;outline:none;margin-bottom:7px}
.prop-inp:focus{border-color:var(--cyan)}
.ab{width:100%;padding:6px;border-radius:6px;border:none;cursor:pointer;font-family:var(--font);
  font-size:11px;font-weight:700;margin-bottom:4px;transition:.14s}
.ab-p{background:linear-gradient(135deg,var(--cyan),var(--cyan2));color:#000}
.ab-s{background:rgba(57,255,20,.1);color:var(--green);border:1px solid rgba(57,255,20,.2)}
.ab-d{background:rgba(255,51,85,.08);color:var(--red);border:1px solid rgba(255,51,85,.2)}
/* SCRIPT */
#panel-script{background:var(--bg);overflow:hidden}
.ed-bar{background:var(--bg2);border-bottom:1px solid var(--border);
  padding:6px 10px;display:flex;align-items:center;gap:6px;flex-shrink:0}
.ed-ttl{font-family:var(--pixel);font-size:7px;color:var(--cyan)}
.file-tabs{display:flex;gap:2px;overflow-x:auto;flex:1}
.ftab{padding:4px 8px;border-radius:5px 5px 0 0;font-size:11px;font-weight:700;cursor:pointer;
  border:1px solid var(--border);border-bottom:none;background:var(--bg3);color:var(--muted);white-space:nowrap}
.ftab.active{background:var(--bg);color:var(--cyan)}
.ed-body{flex:1;display:flex;overflow:hidden}
.ftree{width:148px;min-width:148px;background:var(--bg2);border-right:1px solid var(--border);padding:8px;overflow-y:auto}
.ft-ttl{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:7px}
.ft-item{display:flex;align-items:center;gap:5px;padding:4px 5px;border-radius:5px;cursor:pointer;
  font-size:12px;font-weight:600;transition:.11s;color:var(--muted)}
.ft-item:hover{background:var(--bg3);color:var(--text)}
.ft-item.active{background:rgba(0,229,255,.07);color:var(--cyan)}
.ed-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.code-wrap{flex:1;display:flex;overflow:hidden}
.line-nums{background:var(--bg2);border-right:1px solid var(--border);padding:12px 6px;
  font-family:var(--mono);font-size:12px;line-height:22px;color:var(--muted);
  text-align:right;user-select:none;min-width:40px;overflow:hidden}
#codeEditor{flex:1;background:var(--bg);padding:12px;font-family:var(--mono);font-size:12px;
  line-height:22px;color:var(--text);border:none;outline:none;resize:none;overflow:auto;tab-size:2}
.con-pane{height:115px;background:var(--bg2);border-top:1px solid var(--border);display:flex;flex-direction:column}
.con-hdr{padding:5px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;font-size:11px;font-weight:700;color:var(--muted)}
.con-out{flex:1;overflow-y:auto;padding:5px 10px;font-family:var(--mono);font-size:11px;line-height:1.9}
.cl{color:var(--text)}.ce{color:var(--red)}.ci{color:var(--cyan)}.cs{color:var(--green)}
/* MODAL */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:300;
  display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal-ov.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;
  padding:21px;width:min(340px,92vw);animation:mIn .2s ease}
@keyframes mIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
.modal-close{float:right;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer}
.modal-title{font-family:var(--pixel);font-size:8px;color:var(--cyan);margin-bottom:10px}
.modal-actions{display:flex;gap:6px;margin-top:12px}
.modal-actions button{flex:1;padding:8px;border-radius:8px;border:none;cursor:pointer;
  font-family:var(--font);font-size:13px;font-weight:700;transition:.13s}
.notif{position:fixed;bottom:13px;right:13px;background:var(--bg2);border:1px solid var(--cyan);
  border-radius:9px;padding:8px 13px;z-index:500;font-weight:700;font-size:12px;color:var(--cyan);
  animation:nIn .2s ease;max-width:230px;pointer-events:none}
@keyframes nIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
@media(max-width:768px){
  #sidebar{width:43px}.panel,#hud{left:43px}
  #chat-wrap{left:51px;width:190px}
  #joy-wrap{display:block}#mob-jump{display:flex}#mob-cam{display:block}
  #pp,#bpicker{display:none}
  .std-rt,.av-right{display:none}
  .std-sb{width:105px;min-width:105px}.ftree{width:105px;min-width:105px}
  .av-left{width:130px;min-width:130px}}
</style>
</head>
<body>
<!-- LOBBY -->
<div id="screen-lobby" class="screen visible">
  <div class="lobby-bg"></div>
  <div style="text-align:center;z-index:1;width:100%;display:flex;flex-direction:column;align-items:center">
    <div class="logo">BLOCKVERSE</div>
    <div class="logo-sub">3D Multiplayer ¬∑ Build ¬∑ Play ¬∑ Customize</div>
    <div class="join-card">
      <div class="ig"><label class="lbl">Username</label>
        <input class="inp" id="inp-name" placeholder="Masukkan username..." maxlength="20" value="Player"></div>
      <div class="ig"><label class="lbl">Warna Body</label>
        <div class="color-row" id="color-row"></div></div>
      <div class="ig"><label class="lbl">Pilih Room</label>
        <div class="rooms-list" id="rooms-list">
          <div style="color:var(--muted);font-size:12px;padding:6px">Connecting...</div></div></div>
      <button class="btn-join" id="btn-join" disabled onclick="joinRoom()">‚ñ∂ Join World</button>
      <div id="status-bar">Menghubungkan ke server...</div>
    </div>
  </div>
</div>
<!-- SIDEBAR -->
<div id="sidebar">
  <div class="logo-icon">B</div>
  <div class="nav-item active" id="nav-game"   onclick="showPanel('game')">üéÆ<span class="nav-tt">Play</span></div>
  <div class="nav-item"        id="nav-browse" onclick="showPanel('browse')">üåç<span class="nav-tt">Rooms</span></div>
  <div class="nav-item"        id="nav-market" onclick="showPanel('market')">üõí<span class="nav-tt">Marketplace</span></div>
  <div class="nav-item"        id="nav-avatar" onclick="showPanel('avatar')">üë§<span class="nav-tt">Avatar</span></div>
  <div class="nav-item"        id="nav-studio" onclick="showPanel('studio')">üèóÔ∏è<span class="nav-tt">Studio</span></div>
  <div class="nav-item"        id="nav-script" onclick="showPanel('script')">üìú<span class="nav-tt">Scripts</span></div>
  <div class="sb-bot">
    <div class="nav-item" onclick="toggleCam()">üéØ<span class="nav-tt">Aim Mode</span></div>
    <div class="av-orb" id="my-avatar" onclick="showPanel('avatar')"></div>
  </div>
</div>
<!-- GAME -->
<div id="panel-game" class="panel">
  <canvas id="gameCanvas"></canvas>
  <div id="hud">
    <span class="hud-room" id="hud-room">LOADING</span>
    <span class="hud-pct"><div class="dot-on"></div><span id="hud-pc">0 Players</span></span>
    <div class="hud-r">
      <div class="hud-coins">ü™ô <span id="hud-coins">0</span></div>
      <div class="hp-wrap"><span style="font-size:9px;color:var(--muted)">HP</span>
        <div class="hp-bar"><div class="hp-fill" id="hp-fill" style="width:100%"></div></div>
        <span id="hp-val" style="font-size:9px">100</span></div>
      <button class="hbtn hbtn-g" onclick="showPanel('market')">üõí</button>
      <button class="hbtn hbtn-r" onclick="leaveGame()">‚¨Ö Leave</button>
    </div>
  </div>
  <div id="cam-hint">üñ±Ô∏è Klik canvas putar kamera &nbsp;|&nbsp; WASD gerak &nbsp;|&nbsp; Space lompat &nbsp;|&nbsp; T chat</div>
  <div id="crosshair"></div>
  <div id="pp"><div class="pp-t">Players</div><div id="pp-list"></div></div>
  <div id="chat-wrap">
    <div id="chat-msgs"></div>
    <form id="chat-form" onsubmit="sendChat(event)">
      <input id="chat-inp" placeholder="T untuk chat..." autocomplete="off">
      <button type="submit" id="chat-send">‚Üµ</button>
    </form>
  </div>
  <div id="bpicker"></div>
  <div id="joy-wrap"><div class="joy-base" id="joy-base"><div class="joy-stick" id="joy-stick"></div></div></div>
  <div id="mob-jump" ontouchstart="doJump()">‚¨Ü</div>
  <div id="mob-cam"></div>
</div>
<!-- BROWSE -->
<div id="panel-browse" class="panel">
  <div style="padding:16px;overflow-y:auto;flex:1">
    <div class="p-title">üåç AVAILABLE WORLDS</div>
    <div class="rooms-grid" id="browse-grid"></div>
  </div>
</div>
<!-- MARKETPLACE -->
<div id="panel-market" class="panel">
  <div class="mkt-hdr">
    <span class="mkt-title">üõí MARKETPLACE</span>
    <div class="mkt-cats" id="mkt-cats"></div>
    <div class="mkt-bal">ü™ô <span id="mkt-bal">0</span> Coins</div>
  </div>
  <div class="mkt-body">
    <div class="mkt-search"><span>üîç</span>
      <input type="text" placeholder="Cari item..." id="mkt-search" oninput="renderMarket()"></div>
    <div class="items-grid" id="items-grid"></div>
  </div>
</div>
<!-- AVATAR -->
<div id="panel-avatar" class="panel">
  <div class="av-hdr">
    <span class="av-title">üë§ AVATAR STUDIO</span>
    <div style="margin-left:auto">
      <button class="ar-btn ar-save" style="width:auto;padding:6px 12px" onclick="saveAvatar()">üíæ Save & Apply</button>
    </div>
  </div>
  <div class="av-body">
    <div class="av-left">
      <div class="av-sec"><div class="av-sec-ttl">üé® Body Color</div>
        <div class="av-sec-body"><div class="av-colors" id="av-body-colors"></div></div></div>
      <div class="av-sec"><div class="av-sec-ttl">üë§ Skin Tone</div>
        <div class="av-sec-body"><div class="av-colors" id="av-skin-colors"></div></div></div>
      <div class="av-sec"><div class="av-sec-ttl">üé© Hats</div>
        <div class="av-sec-body"><div class="av-acc-grid" id="av-hats"></div></div></div>
      <div class="av-sec"><div class="av-sec-ttl">‚ú® Accessories</div>
        <div class="av-sec-body"><div class="av-acc-grid" id="av-accs"></div></div></div>
      <div class="av-sec"><div class="av-sec-ttl">üí´ Effects</div>
        <div class="av-sec-body"><div class="av-acc-grid" id="av-effects"></div></div></div>
    </div>
    <div class="av-preview">
      <canvas id="avatarCanvas"></canvas>
      <div class="av-info">Drag rotate ¬∑ Scroll zoom</div>
    </div>
    <div class="av-right">
      <div class="ar-ttl">Profile</div>
      <div class="ar-stat"><span>Level</span><span class="ar-val" id="av-level">1</span></div>
      <div class="ar-stat"><span>Coins</span><span class="ar-val" id="av-coins">0</span></div>
      <div class="ar-stat"><span>Items</span><span class="ar-val" id="av-items">0</span></div>
      <div class="ar-stat"><span>Hat</span><span class="ar-val" id="av-hat-name">None</span></div>
      <div class="ar-stat"><span>Acc</span><span class="ar-val" id="av-acc-name">None</span></div>
      <div class="ar-stat"><span>Effect</span><span class="ar-val" id="av-eff-name">None</span></div>
      <div class="ar-actions">
        <button class="ar-btn ar-save" onclick="saveAvatar()">üíæ Save & Apply</button>
        <button class="ar-btn ar-reset" onclick="resetAvatar()">‚Ü∫ Reset</button>
      </div>
    </div>
  </div>
</div>
<!-- STUDIO -->
<div id="panel-studio" class="panel">
  <div class="std-hdr">
    <span class="std-ttl">3D STUDIO</span>
    <div class="tgrp">
      <button class="tbtn active" id="stbtn-place" onclick="setSTool('place')" title="Place">üß±</button>
      <button class="tbtn" id="stbtn-erase" onclick="setSTool('erase')" title="Erase">‚¨ú</button>
      <button class="tbtn" id="stbtn-pick"  onclick="setSTool('pick')"  title="Pick">üé®</button>
    </div>
    <div class="tgrp">
      <button class="tbtn" onclick="undoSt()" title="Undo">‚Ü©Ô∏è</button>
      <button class="tbtn" onclick="clearSt()" title="Clear">üóëÔ∏è</button>
    </div>
    <div style="margin-left:auto">
      <button class="ab ab-p" style="width:auto;padding:5px 10px;margin:0" onclick="pushMap()">üì§ Push to Server</button>
    </div>
  </div>
  <div class="std-body">
    <div class="std-sb"><div class="s-ttl">Blocks</div><div class="blk-grid" id="std-blk-grid"></div></div>
    <div class="std-3d">
      <canvas id="studioCanvas"></canvas>
      <div class="std-info">LMB Place | RMB Erase | Scroll Zoom | Mid-drag Orbit</div>
    </div>
    <div class="std-rt">
      <div class="s-ttl">Settings</div>
      <label class="prop-lbl">Map Name</label>
      <input class="prop-inp" id="map-name" value="My World">
      <label class="prop-lbl">Sky</label>
      <select class="prop-inp" id="map-sky" onchange="updateSky()">
        <option value="day">‚òÄÔ∏è Day</option><option value="night">üåô Night</option>
        <option value="dusk">üåÜ Dusk</option><option value="space">üöÄ Space</option>
      </select>
      <div class="s-ttl" style="margin-top:8px">Objects</div>
      <button class="ab ab-s" onclick="showNotif('Spawn added!','üìç')">üìç Spawn</button>
      <button class="ab ab-s" onclick="showNotif('Portal added!','üåÄ')">üåÄ Portal</button>
      <button class="ab ab-d" onclick="clearSt()">üóëÔ∏è Clear All</button>
    </div>
  </div>
</div>
<!-- SCRIPT -->
<div id="panel-script" class="panel">
  <div class="ed-bar">
    <span class="ed-ttl">LUA EDITOR</span>
    <div class="file-tabs" id="file-tabs"></div>
    <div style="display:flex;gap:4px">
      <button class="tbtn" style="width:auto;padding:0 8px" onclick="newScript()">+ New</button>
      <button class="ab ab-p" style="width:auto;padding:4px 10px;margin:0" onclick="runScript()">‚ñ∂ Run</button>
    </div>
  </div>
  <div class="ed-body">
    <div class="ftree">
      <div class="ft-ttl">Scripts</div>
      <div id="file-list"></div>
      <div style="margin-top:9px;border-top:1px solid var(--border);padding-top:8px">
        <div class="ft-ttl">Services</div>
        <div class="ft-item">‚öôÔ∏è GameService</div>
        <div class="ft-item">üë• Players</div>
        <div class="ft-item">üåç Workspace</div>
        <div class="ft-item">üíæ DataStore</div>
        <div class="ft-item">üîó RemoteEvents</div>
      </div>
    </div>
    <div class="ed-main">
      <div class="code-wrap">
        <div class="line-nums" id="line-nums">1</div>
        <textarea id="codeEditor" spellcheck="false" oninput="syncLines();autoSave()"></textarea>
      </div>
      <div class="con-pane">
        <div class="con-hdr">
          <span>‚¨õ Console</span>
          <span id="ws-ind" style="font-size:10px;color:var(--green)">‚óè Connected</span>
          <button class="tbtn" style="margin-left:auto;width:auto;padding:0 7px" onclick="clearCon()">Clear</button>
        </div>
        <div class="con-out" id="con-out"><div class="ci">[BV] Lua 5.4 ready.</div></div>
      </div>
    </div>
  </div>
</div>
<!-- BUY MODAL -->
<div class="modal-ov" id="buy-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title">CONFIRM PURCHASE</div>
    <div style="font-size:56px;text-align:center;margin:10px 0" id="modal-icon">üé©</div>
    <div id="modal-name" style="font-size:15px;font-weight:700;text-align:center;margin-bottom:4px"></div>
    <div id="modal-desc" style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:10px"></div>
    <div style="background:var(--bg3);border-radius:8px;padding:9px;text-align:center">
      <div style="font-family:var(--pixel);font-size:9px;color:var(--gold)">ü™ô <span id="modal-price"></span> Coins</div>
      <div style="font-size:10px;color:var(--muted);margin-top:3px">Sisa: <span id="modal-after" style="color:var(--cyan);font-weight:700"></span></div>
    </div>
    <div class="modal-actions">
      <button style="background:var(--bg3);color:var(--text)" onclick="closeModal()">Batal</button>
      <button id="modal-confirm" style="background:linear-gradient(135deg,var(--gold),#b8860b);color:#000" onclick="confirmBuy()">ü™ô Beli</button>
    </div>
  </div>
</div>
<script>
'use strict';
// ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê
function buildWsUrl(){
  if(location.protocol==='file:') return 'ws://localhost:3000';
  return (location.protocol==='https:'?'wss:':'ws:')+'//'+location.host;
}
const WS_URL=buildWsUrl();
console.log('[BV] WS ‚Üí',WS_URL);
const COLORS=['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c','#00e5ff','#ff6b35','#ff3355','#ffd700','#ec407a','#26c6da'];
const SKINS=['#FFDFC4','#F0C27F','#C68642','#8D5524','#4A2912','#FFE0BD'];
const BLOCKS=[
  {id:'grass',icon:'üåø',color:0x3a7d44,label:'Grass'},{id:'stone',icon:'ü™®',color:0x666688,label:'Stone'},
  {id:'brick',icon:'üß±',color:0x8b4513,label:'Brick'},{id:'wood',icon:'üå≤',color:0x8b6914,label:'Wood'},
  {id:'sand',icon:'üèúÔ∏è',color:0xd4a84b,label:'Sand'},{id:'water',icon:'üíß',color:0x1a6090,label:'Water'},
  {id:'lava',icon:'üî•',color:0xcc2200,label:'Lava'},{id:'ice',icon:'‚ùÑÔ∏è',color:0xa8d8f0,label:'Ice'},
  {id:'snow',icon:'‚¨ú',color:0xddeeff,label:'Snow'},{id:'metal',icon:'‚öôÔ∏è',color:0x445577,label:'Metal'},
  {id:'glass',icon:'üî∑',color:0x88ccff,label:'Glass'},{id:'gold',icon:'‚ú®',color:0xd4af37,label:'Gold'},
  {id:'obsidian',icon:'üåë',color:0x1a0a2e,label:'Obsidian'},{id:'leaf',icon:'üçÉ',color:0x228b22,label:'Leaf'},
];
const MARKET=[
  {id:'hat_cap',cat:'hats',icon:'üß¢',name:'Baseball Cap',desc:'Sporty cap.',price:100,rarity:'common',owned:false,equipped:false},
  {id:'hat_cowboy',cat:'hats',icon:'ü§†',name:'Cowboy Hat',desc:'Yee-haw!',price:250,rarity:'rare',owned:false,equipped:false},
  {id:'hat_crown',cat:'hats',icon:'üëë',name:'Gold Crown',desc:'For royalty.',price:1500,rarity:'legendary',owned:false,equipped:false},
  {id:'hat_wizard',cat:'hats',icon:'üßô',name:'Wizard Hat',desc:'Magical.',price:400,rarity:'epic',owned:false,equipped:false},
  {id:'hat_santa',cat:'hats',icon:'üéÖ',name:'Santa Hat',desc:'Ho ho ho!',price:300,rarity:'rare',owned:false,equipped:false},
  {id:'hat_tophat',cat:'hats',icon:'üé©',name:'Top Hat',desc:'Classy.',price:180,rarity:'common',owned:false,equipped:false},
  {id:'acc_glasses',cat:'accessories',icon:'üï∂Ô∏è',name:'Shades',desc:'Rockstar.',price:150,rarity:'common',owned:false,equipped:false},
  {id:'acc_bow',cat:'accessories',icon:'üéÄ',name:'Bow Tie',desc:'Fancy.',price:120,rarity:'common',owned:false,equipped:false},
  {id:'acc_sword',cat:'accessories',icon:'‚öîÔ∏è',name:'Sword',desc:'Tiny blade.',price:350,rarity:'rare',owned:false,equipped:false},
  {id:'acc_wings',cat:'accessories',icon:'ü¶ã',name:'Butterfly Wings',desc:'Flutter.',price:800,rarity:'epic',owned:false,equipped:false},
  {id:'acc_angel',cat:'accessories',icon:'üëº',name:'Angel Wings',desc:'Heavenly.',price:1200,rarity:'legendary',owned:false,equipped:false},
  {id:'acc_shield',cat:'accessories',icon:'üõ°Ô∏è',name:'Shield',desc:'+50 DEF.',price:450,rarity:'epic',owned:false,equipped:false},
  {id:'eff_fire',cat:'effects',icon:'üî•',name:'Fire Aura',desc:'Blazing.',price:600,rarity:'epic',owned:false,equipped:false},
  {id:'eff_ice',cat:'effects',icon:'‚ùÑÔ∏è',name:'Ice Trail',desc:'Frozen path.',price:550,rarity:'epic',owned:false,equipped:false},
  {id:'eff_stars',cat:'effects',icon:'‚≠ê',name:'Star Burst',desc:'Stars follow.',price:2000,rarity:'legendary',owned:false,equipped:false},
  {id:'eff_rainbow',cat:'effects',icon:'üåà',name:'Rainbow',desc:'Colorful.',price:1800,rarity:'legendary',owned:false,equipped:false},
  {id:'eff_hearts',cat:'effects',icon:'üíï',name:'Hearts',desc:'Love vibes.',price:400,rarity:'rare',owned:false,equipped:false},
  {id:'eff_smoke',cat:'effects',icon:'üí®',name:'Smoke',desc:'Mysterious.',price:300,rarity:'common',owned:false,equipped:false},
  {id:'chr_neon',cat:'characters',icon:'üåü',name:'Neon Pack',desc:'Glowing.',price:500,rarity:'rare',owned:false,equipped:false},
  {id:'chr_robot',cat:'characters',icon:'ü§ñ',name:'Robot Skin',desc:'Metallic.',price:700,rarity:'epic',owned:false,equipped:false},
  {id:'chr_ghost',cat:'characters',icon:'üëª',name:'Ghost Skin',desc:'Spooky.',price:900,rarity:'epic',owned:false,equipped:false},
  {id:'chr_dino',cat:'characters',icon:'ü¶ï',name:'Dino Skin',desc:'Rawr!',price:1000,rarity:'legendary',owned:false,equipped:false},
  {id:'map_desert',cat:'maps',icon:'üèúÔ∏è',name:'Desert World',desc:'Hot sandbox.',price:800,rarity:'rare',owned:false,equipped:false},
  {id:'map_ocean',cat:'maps',icon:'üåä',name:'Ocean World',desc:'Deep sea.',price:1000,rarity:'epic',owned:false,equipped:false},
  {id:'map_space',cat:'maps',icon:'üöÄ',name:'Space Station',desc:'Zero-G.',price:1500,rarity:'legendary',owned:false,equipped:false},
];
const MCATS=['all','hats','accessories','effects','characters','maps'];
const SCRIPTS=[
{name:'PlayerController.lua',content:'-- Player Controller\nlocal Players = game:GetService("Players")\nlocal player = Players.LocalPlayer\nlocal SPEED = 16\nlocal UIS = game:GetService("UserInputService")\nUIS.InputBegan:Connect(function(input,proc)\n  if proc then return end\n  if input.KeyCode == Enum.KeyCode.LeftShift then\n    player.Character.Humanoid.WalkSpeed = SPEED * 1.8\n    print("Sprint ON")\n  end\nend)\nUIS.InputEnded:Connect(function(input)\n  if input.KeyCode == Enum.KeyCode.LeftShift then\n    player.Character.Humanoid.WalkSpeed = SPEED\n    print("Sprint OFF")\n  end\nend)\nprint("PlayerController loaded: " .. player.Name)\n'},
{name:'GameManager.lua',content:'-- Game Manager\nlocal CONFIG = {roundTime=120, minPlayers=2}\nlocal GM = {}; GM.__index = GM\nfunction GM.new()\n  return setmetatable({state="waiting",scores={}},GM)\nend\nfunction GM:startRound(players)\n  if #players < CONFIG.minPlayers then\n    warn("Not enough players!")\n    return false\n  end\n  self.state = "active"\n  for _,p in ipairs(players) do\n    self.scores[p.Name] = 0\n    print("Spawned: " .. p.Name)\n  end\n  print("Round started! " .. CONFIG.roundTime .. "s")\n  return true\nend\nfunction GM:addScore(name,pts)\n  self.scores[name] = (self.scores[name] or 0) + pts\n  print(name .. " -> " .. self.scores[name] .. " pts")\nend\nlocal manager = GM.new()\nmanager:startRound(game.Players:GetPlayers())\n'},
{name:'ShopSystem.lua',content:'-- Shop System\nlocal ITEMS = {\n  {id="sword", name="Iron Sword", price=100},\n  {id="potion", name="HP Potion", price=25},\n  {id="wings", name="Wings", price=200},\n}\nlocal function buy(player,itemId)\n  local item = nil\n  for _,i in ipairs(ITEMS) do\n    if i.id == itemId then item=i; break end\n  end\n  if not item then return false,"Not found" end\n  print(player.Name .. " bought " .. item.name)\n  return true,"OK"\nend\ngame.Events.Buy:Connect(function(player,id)\n  local ok,msg = buy(player,id)\n  game.Events.Reply:Fire(player,ok,msg)\nend)\nprint("Shop ready - " .. #ITEMS .. " items")\n'},
];
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let ws=null,myId=null,myName='Player',myColor=COLORS[0];
let remotePlayers={},localPlayer={x:0,y:2,z:0};
let keys={},joyX=0,joyY=0,chatFocus=false,selectedRoom=null;
let coins=parseInt(localStorage.getItem('bv_coins')||'500');
let marketItems=JSON.parse(localStorage.getItem('bv_items')||'null')||JSON.parse(JSON.stringify(MARKET));
let activeCat='all',pendingBuyId=null,curScript=0,selBlock='grass';
let avatarState=JSON.parse(localStorage.getItem('bv_avatar')||'null')||{bodyColor:COLORS[0],skinTone:SKINS[0],hat:null,accessory:null,effect:null};
let gR,gS,gC,bMeshes={},gAnim;
let sR,sS,sC,sMeshes={},sBlocks=[],sHist=[],sTool='place',sSelBlock='grass';
let sTheta=0.8,sPhi=0.6,sDist=18,sAnimR;
let aR,aS,aC,aMesh,aAnim,aTheta=0,aDist=4.5;
// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
(function init(){
  const row=document.getElementById('color-row');
  COLORS.forEach((c,i)=>{
    const s=document.createElement('div');
    s.className='cswatch'+(i===0?' active':'');s.style.background=c;
    s.onclick=()=>{document.querySelectorAll('.cswatch').forEach(x=>x.classList.remove('active'));s.classList.add('active');myColor=c;};
    row.appendChild(s);
  });
  const n=localStorage.getItem('bv_name');if(n) document.getElementById('inp-name').value=n;
  updateCoins();initJoystick();connectWS();
})();
function updateCoins(){
  document.getElementById('hud-coins').textContent=coins;
  const m=document.getElementById('mkt-bal');if(m) m.textContent=coins;
  const a=document.getElementById('av-coins');if(a) a.textContent=coins;
}
// ‚ïê‚ïê‚ïê WS ‚ïê‚ïê‚ïê
let wsRec=null,wsConn=false;
function connectWS(){
  if(wsConn&&ws&&ws.readyState===WebSocket.CONNECTING) return;
  wsConn=true;clearTimeout(wsRec);
  setStatus('üîÑ Connecting to '+WS_URL+'...');
  try{ws=new WebSocket(WS_URL);}catch(e){wsConn=false;setStatus('‚ùå Bad URL');return;}
  ws.onopen=()=>{wsConn=false;document.getElementById('btn-join').disabled=false;setStatus('‚úÖ Terhubung! Pilih room.');setWsInd(true);};
  ws.onmessage=e=>{try{handleMsg(JSON.parse(e.data));}catch(ex){console.error(ex);}};
  ws.onerror=()=>{setStatus('‚ùå Tidak bisa connect: '+WS_URL);setWsInd(false);};
  ws.onclose=evt=>{wsConn=false;document.getElementById('btn-join').disabled=true;setWsInd(false);
    if(!evt.wasClean){setStatus('üîå Putus, retry 3s...');wsRec=setTimeout(connectWS,3000);}
    else setStatus('üîå Disconnected.');};
}
function setStatus(t){const e=document.getElementById('status-bar');if(e)e.textContent=t;}
function setWsInd(on){const e=document.getElementById('ws-ind');if(!e)return;e.textContent=on?'‚óè Connected':'‚óè Offline';e.style.color=on?'var(--green)':'var(--red)';}
function send(msg){if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify(msg));}
function handleMsg(msg){
  switch(msg.type){
    case 'welcome':myId=msg.playerId;renderRoomsList(msg.rooms);renderBrowseRooms(msg.rooms);break;
    case 'room_joined':onRoomJoined(msg);break;
    case 'player_joined':addRP(msg.player);updatePList();showNotif(msg.player.name+' joined!','üë§');break;
    case 'player_left':removeRP(msg.id);updatePList();break;
    case 'player_moved':moveRP(msg);break;
    case 'chat':appendChat(msg.message);break;
    case 'block_update':doBlockUpdate(msg);break;
    case 'map_reload':rebuildMap(msg.mapData);showNotif('Map updated!','üó∫Ô∏è');break;
    case 'script_output':showScriptOut(msg.lines);break;
    case 'error':showNotif(msg.text,'‚ö†Ô∏è');break;
    case 'info':showNotif(msg.text,'‚ÑπÔ∏è');break;
  }
}
function renderRoomsList(rooms){
  const c=document.getElementById('rooms-list');c.innerHTML='';
  rooms.forEach(r=>{
    const d=document.createElement('div');d.className='room-item';
    const em=['üåç','‚öîÔ∏è','üèóÔ∏è','üèôÔ∏è'][rooms.indexOf(r)]||'üéÆ';
    d.innerHTML='<div><div class="room-name">'+r.name+'</div><div class="room-count"><div class="dot-on"></div>'+r.playerCount+'/'+r.maxPlayers+'</div></div><span style="font-size:15px">'+em+'</span>';
    d.onclick=()=>{document.querySelectorAll('.room-item').forEach(x=>x.classList.remove('selected'));d.classList.add('selected');selectedRoom=r.id;};
    c.appendChild(d);if(!selectedRoom){d.classList.add('selected');selectedRoom=r.id;}
  });
}
function renderBrowseRooms(rooms){
  const EM=['üåç','‚öîÔ∏è','üèóÔ∏è','üèôÔ∏è'],DE=['Open sandbox.','PvP Arena.','Build zone.','Roleplay.'],BG=['#0a1a0a','#1a0a0a','#0a0a1a','#0a1015'];
  const c=document.getElementById('browse-grid');c.innerHTML='';
  rooms.forEach((r,i)=>{
    const d=document.createElement('div');d.className='rcard';
    d.innerHTML='<div class="rcard-thumb" style="background:'+BG[i%4]+'">'+EM[i%4]+'<div class="rcard-pc"><div class="dot-on"></div>'+r.playerCount+'/'+r.maxPlayers+'</div></div>'
      +'<div class="rcard-body"><div class="rcard-name">'+r.name+'</div><div class="rcard-desc">'+DE[i%4]+'</div>'
      +'<button class="rcard-join" onclick="event.stopPropagation();joinById(\''+r.id+'\')">‚ñ∂ Play Now</button></div>';
    c.appendChild(d);
  });
}
function joinRoom(){
  myName=document.getElementById('inp-name').value.trim()||'Player';
  localStorage.setItem('bv_name',myName);
  if(!selectedRoom){showNotif('Pilih room dulu!','‚ö†Ô∏è');return;}
  send({type:'join_room',roomId:selectedRoom,name:myName,color:myColor});
}
function joinById(id){send({type:'join_room',roomId:id,name:myName,color:myColor});}
// ‚ïê‚ïê‚ïê ENTER GAME ‚ïê‚ïê‚ïê
function onRoomJoined(msg){
  document.getElementById('screen-lobby').classList.remove('visible');
  document.getElementById('sidebar').style.display='flex';
  const av=document.getElementById('my-avatar');av.style.background=myColor;av.textContent=myName[0].toUpperCase();
  document.getElementById('hud-room').textContent=msg.roomName.toUpperCase();
  initGame3D(msg.mapData);
  Object.values(msg.players).forEach(p=>{if(p.id!==myId)addRP(p);});
  msg.chatHistory.forEach(m=>appendChat(m,true));
  showPanel('game');updatePList();
  sBlocks=JSON.parse(JSON.stringify(msg.mapData));
  initStudio3D();initScripts();
  const h=document.getElementById('cam-hint');h.style.opacity='1';setTimeout(()=>h.style.opacity='0',6000);
}
// ‚ïê‚ïê‚ïê 3D ENGINE ‚ïê‚ïê‚ïê
function getBC(t){const b=BLOCKS.find(x=>x.id===t);return b?b.color:0x888888;}
function initGame3D(mapData){
  const cv=document.getElementById('gameCanvas');
  gR=new THREE.WebGLRenderer({canvas:cv,antialias:true});
  gR.setPixelRatio(Math.min(window.devicePixelRatio,2));
  gR.shadowMap.enabled=true;gR.shadowMap.type=THREE.PCFSoftShadowMap;gR.setClearColor(0x87ceeb);
  gS=new THREE.Scene();gS.fog=new THREE.FogExp2(0x87ceeb,0.015);
  gC=new THREE.PerspectiveCamera(75,cv.clientWidth/cv.clientHeight,0.1,300);
  gS.add(new THREE.AmbientLight(0xffffff,0.55));
  const sun=new THREE.DirectionalLight(0xfff5dd,1.1);sun.position.set(30,50,20);sun.castShadow=true;
  sun.shadow.mapSize.width=sun.shadow.mapSize.height=2048;
  sun.shadow.camera.near=1;sun.shadow.camera.far=200;
  sun.shadow.camera.left=sun.shadow.camera.bottom=-60;
  sun.shadow.camera.right=sun.shadow.camera.top=60;
  gS.add(sun);
  gS.add(new THREE.Mesh(new THREE.SphereGeometry(200,16,8),new THREE.MeshBasicMaterial({color:0x87ceeb,side:THREE.BackSide})));
  rebuildMap(mapData);buildMyMesh();cancelAnimationFrame(gAnim);gameLoop();
}
function rebuildMap(mapData){
  Object.values(bMeshes).forEach(m=>gS&&gS.remove(m));bMeshes={};
  if(!gS)return;
  mapData.forEach(b=>{
    const m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshLambertMaterial({color:getBC(b.type)}));
    m.position.set(b.x+.5,b.y+.5,b.z+.5);m.castShadow=true;m.receiveShadow=true;
    gS.add(m);bMeshes[b.x+','+b.y+','+b.z]=m;
  });
}
function doBlockUpdate(msg){
  const k=msg.x+','+msg.y+','+msg.z;
  if(bMeshes[k]){gS.remove(bMeshes[k]);delete bMeshes[k];}
  if(msg.blockType!=='air'){
    const m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshLambertMaterial({color:getBC(msg.blockType)}));
    m.position.set(msg.x+.5,msg.y+.5,msg.z+.5);m.castShadow=true;gS.add(m);bMeshes[k]=m;
  }
}
let myMesh=null;
function buildMyMesh(){
  if(myMesh)gS.remove(myMesh);
  const g=new THREE.Group();
  const body=new THREE.Mesh(new THREE.CylinderGeometry(.3,.3,1.2,8),new THREE.MeshLambertMaterial({color:new THREE.Color(avatarState.bodyColor||myColor)}));
  body.castShadow=true;g.add(body);
  const head=new THREE.Mesh(new THREE.BoxGeometry(.56,.56,.56),new THREE.MeshLambertMaterial({color:new THREE.Color(avatarState.skinTone||SKINS[0])}));
  head.position.y=.88;head.castShadow=true;body.add(head);
  const em=new THREE.MeshLambertMaterial({color:0x111111});
  [-.12,.12].forEach(x=>{const e=new THREE.Mesh(new THREE.BoxGeometry(.09,.09,.05),em);e.position.set(x,.06,.3);head.add(e);});
  const hatItem=marketItems.find(i=>i.id===avatarState.hat&&i.owned);
  if(hatItem){
    const hc=hatItem.id==='hat_crown'?0xffd700:hatItem.id==='hat_cowboy'?0x8b6914:0x222233;
    const hm=new THREE.MeshLambertMaterial({color:hc});
    const brim=new THREE.Mesh(new THREE.CylinderGeometry(.4,.4,.06,16),hm);brim.position.y=.32;head.add(brim);
    const top=new THREE.Mesh(new THREE.CylinderGeometry(.27,.31,.34,16),hm);top.position.y=.54;head.add(top);
    if(hatItem.id==='hat_crown'){for(let i=0;i<5;i++){const a=i/5*Math.PI*2;const sp=new THREE.Mesh(new THREE.ConeGeometry(.07,.2,6),hm);sp.position.set(Math.cos(a)*.23,.78,Math.sin(a)*.23);head.add(sp);}}
  }
  const accItem=marketItems.find(i=>i.id===avatarState.accessory&&i.owned);
  if(accItem&&(accItem.id==='acc_wings'||accItem.id==='acc_angel')){
    const wm=new THREE.MeshLambertMaterial({color:accItem.id==='acc_angel'?0xfffacd:0x88aaff,side:THREE.DoubleSide,transparent:true,opacity:.85});
    [-.52,.52].forEach((x,i)=>{const w=new THREE.Mesh(new THREE.PlaneGeometry(.65,.9),wm);w.position.set(x,.3,-.1);w.rotation.y=i===0?.4:-.4;g.add(w);});
  }
  myMesh=g;gS.add(myMesh);
}
function addRP(p){
  if(p.id===myId||remotePlayers[p.id])return;
  const g=new THREE.Group();
  const body=new THREE.Mesh(new THREE.CylinderGeometry(.3,.3,1.2,8),new THREE.MeshLambertMaterial({color:new THREE.Color(p.color)}));
  body.castShadow=true;g.add(body);
  const head=new THREE.Mesh(new THREE.BoxGeometry(.55,.55,.55),new THREE.MeshLambertMaterial({color:0xffcc88}));
  head.position.y=.87;body.add(head);
  const nc=document.createElement('canvas');nc.width=256;nc.height=56;
  const ctx=nc.getContext('2d');ctx.fillStyle='rgba(0,0,0,0.75)';ctx.fillRect(0,0,256,56);
  ctx.fillStyle=p.color;ctx.font='bold 26px Rajdhani,sans-serif';ctx.textAlign='center';ctx.fillText(p.name,128,38);
  const tag=new THREE.Mesh(new THREE.PlaneGeometry(1.4,.32),new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(nc),transparent:true,depthWrite:false}));
  tag.position.y=1.52;body.add(tag);
  g.position.set(p.x,p.y,p.z);gS.add(g);
  remotePlayers[p.id]={mesh:g,data:p,tag};
}
function removeRP(id){if(remotePlayers[id]){gS.remove(remotePlayers[id].mesh);delete remotePlayers[id];}}
function moveRP(msg){const rp=remotePlayers[msg.id];if(!rp)return;rp.mesh.position.set(msg.x,msg.y,msg.z);rp.mesh.rotation.y=msg.rotY;if(rp.tag)rp.tag.lookAt(gC.position);}
// ‚ïê‚ïê‚ïê PHYSICS & CAMERA ‚ïê‚ïê‚ïê
const SPD=6,JV=9,GRAV=22;
let velY=0,onGround=false,camYaw=0,camPitch=.2,pLocked=false,pLockOn=true;
// Desktop: pointer lock
document.getElementById('gameCanvas').addEventListener('click',()=>{
  if(document.getElementById('panel-game').classList.contains('visible')&&!chatFocus&&pLockOn)
    document.getElementById('gameCanvas').requestPointerLock();
});
document.addEventListener('pointerlockchange',()=>{
  pLocked=!!document.pointerLockElement;
  document.getElementById('crosshair').style.display=pLocked?'block':'none';
});
document.addEventListener('mousemove',e=>{
  if(!pLocked)return;
  camYaw-=e.movementX*.0022;camPitch-=e.movementY*.0022;
  camPitch=Math.max(-1.2,Math.min(.6,camPitch));
});
// Mobile: touch drag on right area
let mcX=0,mcY=0,mcAct=false;
document.getElementById('mob-cam').addEventListener('touchstart',e=>{
  if(chatFocus)return;mcX=e.touches[0].clientX;mcY=e.touches[0].clientY;mcAct=true;e.preventDefault();
},{passive:false});
document.getElementById('mob-cam').addEventListener('touchmove',e=>{
  if(!mcAct||chatFocus)return;
  camYaw-=(e.touches[0].clientX-mcX)*.004;camPitch-=(e.touches[0].clientY-mcY)*.004;
  camPitch=Math.max(-1.2,Math.min(.6,camPitch));
  mcX=e.touches[0].clientX;mcY=e.touches[0].clientY;e.preventDefault();
},{passive:false});
document.getElementById('mob-cam').addEventListener('touchend',()=>mcAct=false);
document.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='KeyT'&&!chatFocus){e.preventDefault();document.getElementById('chat-inp').focus();}
  if(e.code==='Escape'&&document.pointerLockElement)document.exitPointerLock();
});
document.addEventListener('keyup',e=>keys[e.code]=false);
document.getElementById('chat-inp').addEventListener('focus',()=>chatFocus=true);
document.getElementById('chat-inp').addEventListener('blur',()=>chatFocus=false);
function toggleCam(){
  pLockOn=!pLockOn;
  if(!pLockOn&&document.pointerLockElement)document.exitPointerLock();
  showNotif(pLockOn?'Aim ON ‚Äì klik canvas':'Aim OFF','üéØ');
}
document.getElementById('gameCanvas').addEventListener('mousedown',e=>{
  if(!document.getElementById('panel-game').classList.contains('visible')||chatFocus)return;
  if(e.button!==0&&e.button!==2)return;
  const cv=document.getElementById('gameCanvas');
  const mouse=new THREE.Vector2((e.clientX/cv.clientWidth)*2-1,-(e.clientY/cv.clientHeight)*2+1);
  const ray=new THREE.Raycaster();ray.setFromCamera(mouse,gC);
  const hits=ray.intersectObjects(Object.values(bMeshes));
  if(hits.length){
    const hit=hits[0];const offset=hit.face.normal.clone().multiplyScalar(e.button===2?-.5:.5);
    const pos=hit.point.clone().add(offset);
    send({type:'place_block',x:Math.floor(pos.x),y:Math.floor(pos.y),z:Math.floor(pos.z),blockType:e.button===2?'air':selBlock});
  }
});
document.getElementById('gameCanvas').addEventListener('contextmenu',e=>e.preventDefault());
let lastSend=0;
function gameLoop(){
  gAnim=requestAnimationFrame(gameLoop);if(!gR)return;
  const cv=document.getElementById('gameCanvas');
  const W=cv.parentElement.clientWidth,H=cv.parentElement.clientHeight;
  if(gR.domElement.width!==W||gR.domElement.height!==H){gR.setSize(W,H,false);gC.aspect=W/H;gC.updateProjectionMatrix();}
  const dt=1/60;
  if(!chatFocus){
    let dx=0,dz=0;
    const fwd=new THREE.Vector3(-Math.sin(camYaw),0,-Math.cos(camYaw));
    const rgt=new THREE.Vector3(Math.cos(camYaw),0,-Math.sin(camYaw));
    if(keys['KeyW']||keys['ArrowUp']||joyY<-.3){dx+=fwd.x;dz+=fwd.z;}
    if(keys['KeyS']||keys['ArrowDown']||joyY>.3){dx-=fwd.x;dz-=fwd.z;}
    if(keys['KeyA']||keys['ArrowLeft']||joyX<-.3){dx+=rgt.x;dz+=rgt.z;}
    if(keys['KeyD']||keys['ArrowRight']||joyX>.3){dx-=rgt.x;dz-=rgt.z;}
    const spd=(keys['ShiftLeft']||keys['ShiftRight'])?SPD*1.8:SPD;
    const len=Math.sqrt(dx*dx+dz*dz);if(len>0){dx/=len;dz/=len;}
    localPlayer.x+=dx*spd*dt;localPlayer.z+=dz*spd*dt;
    if(keys['Space']&&onGround){velY=JV;onGround=false;}
  }
  velY-=GRAV*dt;localPlayer.y+=velY*dt;
  if(localPlayer.y<2){localPlayer.y=2;velY=0;onGround=true;}
  if(myMesh){myMesh.position.set(localPlayer.x,localPlayer.y-.6,localPlayer.z);myMesh.rotation.y=camYaw;}
  const D=5;
  gC.position.set(localPlayer.x-Math.sin(camYaw)*Math.cos(camPitch)*D,localPlayer.y+Math.sin(camPitch)*D+1,localPlayer.z-Math.cos(camYaw)*Math.cos(camPitch)*D);
  gC.lookAt(localPlayer.x,localPlayer.y+.6,localPlayer.z);
  Object.values(remotePlayers).forEach(rp=>{if(rp.tag)rp.tag.lookAt(gC.position);});
  const now=Date.now();
  if(now-lastSend>100){lastSend=now;send({type:'move',x:localPlayer.x,y:localPlayer.y,z:localPlayer.z,rotY:camYaw});}
  gR.render(gS,gC);
}
function doJump(){if(onGround){velY=JV;onGround=false;}}
function initBPicker(){
  const c=document.getElementById('bpicker');c.innerHTML='';
  BLOCKS.slice(0,8).forEach((b,i)=>{
    const s=document.createElement('div');s.className='bp-slot'+(b.id===selBlock?' active':'');
    s.innerHTML=b.icon+'<span class="bp-num">'+(i+1)+'</span>';s.title=b.label;
    s.onclick=()=>{document.querySelectorAll('.bp-slot').forEach(x=>x.classList.remove('active'));s.classList.add('active');selBlock=b.id;};
    c.appendChild(s);
  });
}
// ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê
function appendChat(m,silent=false){
  const c=document.getElementById('chat-msgs');
  const d=document.createElement('div');d.className='chat-line';
  d.innerHTML='<span class="chat-sn" style="color:'+(m.color||'#fff')+'">'+m.sender+':</span> '+m.text;
  c.appendChild(d);if(c.children.length>50)c.removeChild(c.firstChild);c.scrollTop=c.scrollHeight;
}
function sendChat(e){e.preventDefault();const inp=document.getElementById('chat-inp');const t=inp.value.trim();if(!t)return;send({type:'chat',text:t});inp.value='';inp.blur();chatFocus=false;}
// ‚ïê‚ïê‚ïê PLAYERS ‚ïê‚ïê‚ïê
function updatePList(){
  const c=document.getElementById('pp-list');
  c.innerHTML='<div class="pp-row"><div class="pp-dot" style="background:'+myColor+';box-shadow:0 0 5px '+myColor+'"></div>'+myName+'</div>';
  Object.values(remotePlayers).forEach(rp=>{c.innerHTML+='<div class="pp-row"><div class="pp-dot" style="background:'+rp.data.color+'"></div>'+rp.data.name+'</div>';});
  document.getElementById('hud-pc').textContent=(Object.keys(remotePlayers).length+1)+' Players';
}
// ‚ïê‚ïê‚ïê MARKETPLACE ‚ïê‚ïê‚ïê
function initMarket(){
  const c=document.getElementById('mkt-cats');c.innerHTML='';
  MCATS.forEach(cat=>{
    const b=document.createElement('button');b.className='mcat'+(cat===activeCat?' active':'');
    b.textContent=cat==='all'?'‚ú® All':cat.charAt(0).toUpperCase()+cat.slice(1);
    b.onclick=()=>{activeCat=cat;document.querySelectorAll('.mcat').forEach(x=>x.classList.remove('active'));b.classList.add('active');renderMarket();};
    c.appendChild(b);
  });
  renderMarket();
}
function renderMarket(){
  const q=(document.getElementById('mkt-search')?.value||'').toLowerCase();
  const grid=document.getElementById('items-grid');grid.innerHTML='';
  let items=marketItems;
  if(activeCat!=='all')items=items.filter(i=>i.cat===activeCat);
  if(q)items=items.filter(i=>i.name.toLowerCase().includes(q)||i.desc.toLowerCase().includes(q));
  items.forEach(item=>{
    const canAfford=coins>=item.price;
    const d=document.createElement('div');d.className='icard';
    let btns=item.owned
      ?'<span class="iowned">‚úì Owned</span><div style="display:flex;gap:3px">'
        +'<button class="btn-equip '+(item.equipped?'equipped':'')+'" onclick="toggleEquip(\''+item.id+'\')">'+(item.equipped?'‚úì Eq':'Equip')+'</button>'
        +'<button class="btn-sell" onclick="sellItem(\''+item.id+'\')">Sell</button></div>'
      :'<span class="icost">ü™ô '+item.price+'</span>'
        +'<button class="btn-buy" '+(canAfford?'':'disabled')+' onclick="openBuyModal(\''+item.id+'\')">'+(canAfford?'Buy':'No ü™ô')+'</button>';
    d.innerHTML='<div class="ithumb"><span>'+item.icon+'</span><span class="irarity r-'+item.rarity+'">'+item.rarity+'</span></div>'
      +'<div class="ibody"><div class="iname">'+item.name+'</div><div class="idesc">'+item.desc+'</div>'
      +'<div class="iprice">'+btns+'</div></div>';
    grid.appendChild(d);
  });
  updateCoins();updateAvStats();
}
function openBuyModal(id){
  const item=marketItems.find(i=>i.id===id);if(!item)return;
  pendingBuyId=id;
  document.getElementById('modal-icon').textContent=item.icon;
  document.getElementById('modal-name').textContent=item.name;
  document.getElementById('modal-desc').textContent=item.desc;
  document.getElementById('modal-price').textContent=item.price;
  document.getElementById('modal-after').textContent=(coins-item.price)+' Coins';
  document.getElementById('modal-confirm').disabled=coins<item.price;
  document.getElementById('buy-modal').classList.add('open');
}
function closeModal(){document.getElementById('buy-modal').classList.remove('open');pendingBuyId=null;}
function confirmBuy(){
  if(!pendingBuyId)return;
  const item=marketItems.find(i=>i.id===pendingBuyId);
  if(!item||coins<item.price){showNotif('Coins tidak cukup!','üí∏');closeModal();return;}
  coins-=item.price;item.owned=true;saveMkt();closeModal();renderMarket();
  showNotif(item.icon+' '+item.name+' dibeli!','üõí');
}
function sellItem(id){
  const item=marketItems.find(i=>i.id===id);if(!item||!item.owned)return;
  const sp=Math.floor(item.price*.4);coins+=sp;item.owned=false;item.equipped=false;
  if(avatarState.hat===id)avatarState.hat=null;
  if(avatarState.accessory===id)avatarState.accessory=null;
  if(avatarState.effect===id)avatarState.effect=null;
  saveMkt();saveAv();renderMarket();showNotif('Dijual ü™ô '+sp+'!','üí∞');
}
function toggleEquip(id){
  const item=marketItems.find(i=>i.id===id);if(!item||!item.owned)return;
  const km={hats:'hat',accessories:'accessory',effects:'effect'};const avk=km[item.cat];
  if(!avk){showNotif(item.name+' applied!','‚ú®');return;}
  if(avatarState[avk]===id){avatarState[avk]=null;item.equipped=false;}
  else{const prev=marketItems.find(i=>i.id===avatarState[avk]);if(prev)prev.equipped=false;avatarState[avk]=id;item.equipped=true;}
  saveMkt();saveAv();renderMarket();buildMyMesh();buildAvMesh();
  showNotif(item.equipped?item.icon+' '+item.name+' equipped!':item.name+' unequipped','üëó');
}
function saveMkt(){localStorage.setItem('bv_coins',coins);localStorage.setItem('bv_items',JSON.stringify(marketItems));updateCoins();}
function earnCoins(n){coins+=n;saveMkt();showNotif('+'+n+' ü™ô!','‚ú®');}
// ‚ïê‚ïê‚ïê AVATAR ‚ïê‚ïê‚ïê
function initAvPanel(){
  const bc=document.getElementById('av-body-colors');bc.innerHTML='';
  COLORS.forEach(c=>{const el=document.createElement('div');el.className='av-col'+(avatarState.bodyColor===c?' active':'');el.style.background=c;
    el.onclick=()=>{document.querySelectorAll('#av-body-colors .av-col').forEach(x=>x.classList.remove('active'));el.classList.add('active');avatarState.bodyColor=c;buildAvMesh();buildMyMesh();};bc.appendChild(el);});
  const sc=document.getElementById('av-skin-colors');sc.innerHTML='';
  SKINS.forEach(c=>{const el=document.createElement('div');el.className='av-col'+(avatarState.skinTone===c?' active':'');el.style.background=c;
    el.onclick=()=>{document.querySelectorAll('#av-skin-colors .av-col').forEach(x=>x.classList.remove('active'));el.classList.add('active');avatarState.skinTone=c;buildAvMesh();};sc.appendChild(el);});
  buildAvGrid('av-hats',marketItems.filter(i=>i.cat==='hats'),'hat');
  buildAvGrid('av-accs',marketItems.filter(i=>i.cat==='accessories'),'accessory');
  buildAvGrid('av-effects',marketItems.filter(i=>i.cat==='effects'),'effect');
  if(!aR)initAv3D();else buildAvMesh();
  updateAvStats();
}
function buildAvGrid(cid,items,avk){
  const c=document.getElementById(cid);c.innerHTML='';
  const none=document.createElement('div');none.className='av-acc'+(avatarState[avk]===null?' equipped':'');
  none.innerHTML='üö´<span>None</span>';
  none.onclick=()=>{const prev=marketItems.find(i=>i.id===avatarState[avk]);if(prev)prev.equipped=false;avatarState[avk]=null;buildAvGrid(cid,items,avk);buildAvMesh();buildMyMesh();saveAv();saveMkt();};
  c.appendChild(none);
  items.forEach(item=>{
    const el=document.createElement('div');
    el.className='av-acc'+(avatarState[avk]===item.id?' equipped':'')+(item.owned?'':' locked');
    el.innerHTML=item.icon+'<span>'+item.name.split(' ')[0]+'</span>';el.title=item.owned?item.name:'üîí Buy in Marketplace';
    el.onclick=()=>{
      if(!item.owned){showNotif('Beli '+item.name+' dulu!','üîí');return;}
      const prev=marketItems.find(i=>i.id===avatarState[avk]);if(prev)prev.equipped=false;
      avatarState[avk]=item.id;item.equipped=true;
      buildAvGrid(cid,items,avk);buildAvMesh();buildMyMesh();saveAv();saveMkt();
    };c.appendChild(el);
  });
}
function updateAvStats(){
  const owned=marketItems.filter(i=>i.owned).length;
  const hat=marketItems.find(i=>i.id===avatarState.hat);
  const acc=marketItems.find(i=>i.id===avatarState.accessory);
  const eff=marketItems.find(i=>i.id===avatarState.effect);
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set('av-hat-name',hat?hat.name:'None');set('av-acc-name',acc?acc.name:'None');
  set('av-eff-name',eff?eff.name:'None');set('av-items',owned);
  set('av-coins',coins);set('av-level',Math.max(1,Math.floor(owned/3)+1));
}
function initAv3D(){
  const cv=document.getElementById('avatarCanvas');
  if(aR){aR.dispose();cancelAnimationFrame(aAnim);}
  aR=new THREE.WebGLRenderer({canvas:cv,antialias:true,alpha:true});
  aR.setPixelRatio(Math.min(window.devicePixelRatio,2));aR.setClearColor(0,0);aR.shadowMap.enabled=true;
  aS=new THREE.Scene();aC=new THREE.PerspectiveCamera(50,1,0.1,50);
  aS.add(new THREE.AmbientLight(0xffffff,.7));
  const al=new THREE.DirectionalLight(0xffffff,.9);al.position.set(5,10,5);al.castShadow=true;aS.add(al);
  aS.add(mkMesh3(new THREE.CylinderGeometry(1.5,1.5,.08,32),0x1a1a2e,{y:-.95}));
  buildAvMesh();avLoop();initAvControls(cv);
}
function buildAvMesh(){
  if(!aS)return;if(aMesh)aS.remove(aMesh);
  const g=new THREE.Group();
  g.add(mkMesh3(new THREE.CylinderGeometry(.33,.33,1.3,10),avatarState.bodyColor,{y:0}));
  [-.44,.44].forEach((x,i)=>{const a=mkMesh3(new THREE.CylinderGeometry(.1,.1,.9,8),avatarState.bodyColor,{x,y:.1});a.rotation.z=i===0?.3:-.3;g.add(a);});
  [-.16,.16].forEach(x=>g.add(mkMesh3(new THREE.CylinderGeometry(.13,.13,.8,8),0x1a3a6a,{x,y:-1.05})));
  const head=mkMesh3(new THREE.BoxGeometry(.62,.62,.62),avatarState.skinTone,{y:.96});
  const em=new THREE.MeshLambertMaterial({color:0x111111});
  [-.13,.13].forEach(x=>{const e=new THREE.Mesh(new THREE.BoxGeometry(.1,.1,.05),em);e.position.set(x,.06,.32);head.add(e);});
  const sm=new THREE.Mesh(new THREE.BoxGeometry(.2,.05,.05),new THREE.MeshLambertMaterial({color:0x8b4513}));
  sm.position.set(0,-.1,.32);head.add(sm);g.add(head);
  const hatItem=marketItems.find(i=>i.id===avatarState.hat&&i.owned);
  if(hatItem){
    const hc=hatItem.id==='hat_crown'?0xffd700:hatItem.id==='hat_cowboy'?0x8b6914:0x222233;
    const hm=new THREE.MeshLambertMaterial({color:hc});
    const brim=new THREE.Mesh(new THREE.CylinderGeometry(.43,.43,.06,16),hm);brim.position.y=.32;head.add(brim);
    const top=new THREE.Mesh(new THREE.CylinderGeometry(.28,.32,.36,16),hm);top.position.y=.55;head.add(top);
    if(hatItem.id==='hat_crown'){for(let i=0;i<5;i++){const a=i/5*Math.PI*2;const sp=new THREE.Mesh(new THREE.ConeGeometry(.07,.2,6),hm);sp.position.set(Math.cos(a)*.23,.78,Math.sin(a)*.23);head.add(sp);}}
  }
  const accItem=marketItems.find(i=>i.id===avatarState.accessory&&i.owned);
  if(accItem){
    if(accItem.id==='acc_wings'||accItem.id==='acc_angel'){
      const wm=new THREE.MeshLambertMaterial({color:accItem.id==='acc_angel'?0xfffacd:0x88aaff,side:THREE.DoubleSide,transparent:true,opacity:.85});
      [-.55,.55].forEach((x,i)=>{const w=new THREE.Mesh(new THREE.PlaneGeometry(.7,1),wm);w.position.set(x,.3,-.1);w.rotation.y=i===0?.4:-.4;g.add(w);});
    }
    if(accItem.id==='acc_sword'){const sw=mkMesh3(new THREE.BoxGeometry(.06,.85,.06),0xcccccc,{x:.72,y:-.1});sw.rotation.z=-.2;g.add(sw);}
    if(accItem.id==='acc_shield'){const sh=mkMesh3(new THREE.BoxGeometry(.55,.65,.07),0x4488cc,{x:-.7,y:.15,z:.1});g.add(sh);}
    if(accItem.id==='acc_glasses'){
      const gm=new THREE.MeshLambertMaterial({color:0x111111});
      [-.12,.12].forEach(x=>{const gl=new THREE.Mesh(new THREE.TorusGeometry(.08,.02,6,12),gm);gl.position.set(x,.08,.33);gl.rotation.y=Math.PI/2;head.add(gl);});
    }
  }
  aMesh=g;aS.add(aMesh);
}
function mkMesh3(geo,color,pos){
  const m=new THREE.Mesh(geo,new THREE.MeshLambertMaterial({color:new THREE.Color(color)}));
  if(pos){if(pos.x!==undefined)m.position.x=pos.x;if(pos.y!==undefined)m.position.y=pos.y;if(pos.z!==undefined)m.position.z=pos.z;}
  m.castShadow=true;return m;
}
function avLoop(){
  aAnim=requestAnimationFrame(avLoop);
  const cv=document.getElementById('avatarCanvas');
  const pw=cv.parentElement.clientWidth,ph=cv.parentElement.clientHeight;
  const W=Math.max(200,pw-310),H=Math.max(280,ph);
  if(aR.domElement.width!==W||aR.domElement.height!==H){aR.setSize(W,H,false);aC.aspect=W/H;aC.updateProjectionMatrix();}
  const cx=aDist*Math.sin(aTheta),cz=aDist*Math.cos(aTheta);
  aC.position.set(cx,2.5,cz);aC.lookAt(0,.5,0);
  if(aMesh)aMesh.rotation.y+=.004;
  aR.render(aS,aC);
}
function initAvControls(cv){
  let drag=false,lx=0;
  cv.addEventListener('mousedown',e=>{drag=true;lx=e.clientX;});
  window.addEventListener('mousemove',e=>{if(!drag)return;aTheta-=(e.clientX-lx)*.01;lx=e.clientX;if(aMesh)aMesh.rotation.y=0;});
  window.addEventListener('mouseup',()=>drag=false);
  cv.addEventListener('wheel',e=>{aDist=Math.max(2,Math.min(8,aDist+e.deltaY*.01));e.preventDefault();},{passive:false});
  cv.addEventListener('touchstart',e=>{drag=true;lx=e.touches[0].clientX;e.preventDefault();},{passive:false});
  cv.addEventListener('touchmove',e=>{if(!drag)return;aTheta-=(e.touches[0].clientX-lx)*.013;lx=e.touches[0].clientX;if(aMesh)aMesh.rotation.y=0;e.preventDefault();},{passive:false});
  cv.addEventListener('touchend',()=>drag=false);
}
function saveAvatar(){saveAv();buildMyMesh();renderMarket();showNotif('Avatar saved! üéâ','üë§');}
function saveAv(){localStorage.setItem('bv_avatar',JSON.stringify(avatarState));updateAvStats();}
function resetAvatar(){avatarState={bodyColor:COLORS[0],skinTone:SKINS[0],hat:null,accessory:null,effect:null};marketItems.forEach(i=>i.equipped=false);saveAv();saveMkt();initAvPanel();buildMyMesh();showNotif('Avatar reset!','‚Ü∫');}
// ‚ïê‚ïê‚ïê STUDIO ‚ïê‚ïê‚ïê
function initStudio3D(){
  const cv=document.getElementById('studioCanvas');
  if(sR){sR.dispose();cancelAnimationFrame(sAnimR);}
  sR=new THREE.WebGLRenderer({canvas:cv,antialias:true});sR.setPixelRatio(Math.min(window.devicePixelRatio,2));
  sR.shadowMap.enabled=true;sR.setClearColor(0x0a0a1a);
  sS=new THREE.Scene();sC=new THREE.PerspectiveCamera(65,1,0.1,200);
  sS.add(new THREE.AmbientLight(0xffffff,.6));
  const dl=new THREE.DirectionalLight(0xffffff,.9);dl.position.set(20,30,15);sS.add(dl);
  sS.add(new THREE.GridHelper(80,80,0x222244,0x1a1a33));
  const bg=document.getElementById('std-blk-grid');bg.innerHTML='';
  BLOCKS.forEach(b=>{
    const btn=document.createElement('div');btn.className='blk-btn'+(b.id===sSelBlock?' sel':'');btn.id='sblk-'+b.id;
    btn.innerHTML='<span class="blk-icon">'+b.icon+'</span><div class="blk-lbl">'+b.label+'</div>';
    btn.onclick=()=>{document.querySelectorAll('.blk-btn').forEach(x=>x.classList.remove('sel'));btn.classList.add('sel');sSelBlock=b.id;};
    bg.appendChild(btn);
  });
  rebuildStBlocks();studioLoop();initStudioControls();
}
function rebuildStBlocks(){
  Object.values(sMeshes).forEach(m=>sS.remove(m));sMeshes={};
  sBlocks.forEach(b=>{
    const m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshLambertMaterial({color:getBC(b.type)}));
    m.position.set(b.x+.5,b.y+.5,b.z+.5);m.castShadow=true;sS.add(m);sMeshes[b.x+','+b.y+','+b.z]=m;
  });
}
function studioLoop(){
  sAnimR=requestAnimationFrame(studioLoop);
  const cv=document.getElementById('studioCanvas');
  const W=cv.parentElement.clientWidth,H=cv.parentElement.clientHeight;
  if(sR.domElement.width!==W||sR.domElement.height!==H){sR.setSize(W,H,false);sC.aspect=W/H;sC.updateProjectionMatrix();}
  const cx=sDist*Math.sin(sTheta)*Math.cos(sPhi),cy=sDist*Math.sin(sPhi),cz=sDist*Math.cos(sTheta)*Math.cos(sPhi);
  sC.position.set(cx,cy,cz);sC.lookAt(0,0,0);sR.render(sS,sC);
}
function initStudioControls(){
  const cv=document.getElementById('studioCanvas');
  let orb=false,lx=0,ly=0;
  cv.addEventListener('mousedown',e=>{
    if(e.button===1||e.button===2){orb=true;lx=e.clientX;ly=e.clientY;e.preventDefault();return;}
    if(e.button===0)stRaycast(e,sTool);
  });
  window.addEventListener('mousemove',e=>{if(!orb)return;sTheta-=(e.clientX-lx)*.008;sPhi=Math.max(-1.4,Math.min(1.4,sPhi-(e.clientY-ly)*.008));lx=e.clientX;ly=e.clientY;});
  window.addEventListener('mouseup',e=>{if(e.button===1||e.button===2)orb=false;});
  cv.addEventListener('contextmenu',e=>e.preventDefault());
  cv.addEventListener('wheel',e=>{sDist=Math.max(3,Math.min(60,sDist+e.deltaY*.02));});
  let touches={};
  cv.addEventListener('touchstart',e=>{[...e.touches].forEach(t=>touches[t.identifier]={x:t.clientX,y:t.clientY});e.preventDefault();},{passive:false});
  cv.addEventListener('touchmove',e=>{
    const t=e.touches[0];const prev=touches[t.identifier]||{x:t.clientX,y:t.clientY};
    sTheta-=(t.clientX-prev.x)*.008;sPhi=Math.max(-1.4,Math.min(1.4,sPhi-(t.clientY-prev.y)*.008));
    [...e.touches].forEach(tt=>touches[tt.identifier]={x:tt.clientX,y:tt.clientY});e.preventDefault();
  },{passive:false});
}
function stRaycast(e,tool){
  const cv=document.getElementById('studioCanvas');
  const rect=cv.getBoundingClientRect();
  const mouse=new THREE.Vector2(((e.clientX-rect.left)/rect.width)*2-1,-((e.clientY-rect.top)/rect.height)*2+1);
  const ray=new THREE.Raycaster();ray.setFromCamera(mouse,sC);
  const hits=ray.intersectObjects(Object.values(sMeshes));
  if(hits.length){
    const hit=hits[0];const pos=hit.object.position.clone().subScalar(.5);
    const bx=Math.round(pos.x),by=Math.round(pos.y),bz=Math.round(pos.z);const key=bx+','+by+','+bz;
    if(tool==='erase'){
      sHist.push(JSON.parse(JSON.stringify(sBlocks)));
      sBlocks=sBlocks.filter(b=>!(b.x===bx&&b.y===by&&b.z===bz));
      if(sMeshes[key]){sS.remove(sMeshes[key]);delete sMeshes[key];}
    } else if(tool==='pick'){
      const found=sBlocks.find(b=>b.x===bx&&b.y===by&&b.z===bz);
      if(found){sSelBlock=found.type;document.querySelectorAll('.blk-btn').forEach(x=>x.classList.remove('sel'));document.getElementById('sblk-'+found.type)?.classList.add('sel');}
    } else {
      const norm=hit.face.normal;const np=hit.object.position.clone().addScaledVector(norm,1);
      const nx=Math.round(np.x-.5),ny=Math.round(np.y-.5),nz=Math.round(np.z-.5);const nk=nx+','+ny+','+nz;
      sHist.push(JSON.parse(JSON.stringify(sBlocks)));
      sBlocks=sBlocks.filter(b=>!(b.x===nx&&b.y===ny&&b.z===nz));
      sBlocks.push({x:nx,y:ny,z:nz,type:sSelBlock});
      if(sMeshes[nk])sS.remove(sMeshes[nk]);
      const m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshLambertMaterial({color:getBC(sSelBlock)}));
      m.position.set(nx+.5,ny+.5,nz+.5);m.castShadow=true;sS.add(m);sMeshes[nk]=m;
    }
  } else if(tool==='place'){
    const ray2=new THREE.Raycaster();ray2.setFromCamera(mouse,sC);
    const plane=new THREE.Plane(new THREE.Vector3(0,1,0),0);const pt=new THREE.Vector3();
    ray2.ray.intersectPlane(plane,pt);
    if(pt){
      const bx=Math.floor(pt.x),by=0,bz=Math.floor(pt.z);const key=bx+','+by+','+bz;
      sHist.push(JSON.parse(JSON.stringify(sBlocks)));
      sBlocks=sBlocks.filter(b=>!(b.x===bx&&b.y===by&&b.z===bz));
      sBlocks.push({x:bx,y:by,z:bz,type:sSelBlock});
      if(sMeshes[key])sS.remove(sMeshes[key]);
      const m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshLambertMaterial({color:getBC(sSelBlock)}));
      m.position.set(bx+.5,by+.5,bz+.5);m.castShadow=true;sS.add(m);sMeshes[key]=m;
    }
  }
}
function setSTool(t){sTool=t;document.querySelectorAll('.tbtn[id^="stbtn-"]').forEach(b=>b.classList.remove('active'));document.getElementById('stbtn-'+t)?.classList.add('active');}
function undoSt(){if(sHist.length){sBlocks=sHist.pop();rebuildStBlocks();showNotif('Undone!','‚Ü©Ô∏è');}}
function clearSt(){sHist.push(JSON.parse(JSON.stringify(sBlocks)));sBlocks=[];rebuildStBlocks();showNotif('Cleared!','üóëÔ∏è');}
function updateSky(){const s=document.getElementById('map-sky').value;const c={day:0x87ceeb,night:0x05050f,dusk:0x3a1c2c,space:0x000005};sR.setClearColor(c[s]||0x87ceeb);}
function pushMap(){
  if(!ws||ws.readyState!==1){showNotif('Not connected!','‚ö†Ô∏è');return;}
  send({type:'save_map',mapData:sBlocks});rebuildMap(sBlocks);earnCoins(50);showNotif('Map pushed! +50 ü™ô','üì§');
}
// ‚ïê‚ïê‚ïê SCRIPT ‚ïê‚ïê‚ïê
function initScripts(){
  const fl=document.getElementById('file-list'),tabs=document.getElementById('file-tabs');
  fl.innerHTML='';tabs.innerHTML='';
  SCRIPTS.forEach((s,i)=>{
    const fi=document.createElement('div');fi.className='ft-item'+(i===0?' active':'');fi.id='fi-'+i;
    fi.innerHTML='<span>üìú</span>'+s.name;fi.onclick=()=>loadScript(i);fl.appendChild(fi);
    const tab=document.createElement('div');tab.className='ftab'+(i===0?' active':'');tab.id='ftab-'+i;
    tab.textContent=s.name.replace('.lua','');tab.onclick=()=>loadScript(i);tabs.appendChild(tab);
  });
  loadScript(0);
}
function loadScript(i){
  curScript=i;
  document.querySelectorAll('.ft-item').forEach((el,idx)=>el.classList.toggle('active',idx===i));
  document.querySelectorAll('.ftab').forEach((el,idx)=>el.classList.toggle('active',idx===i));
  document.getElementById('codeEditor').value=SCRIPTS[i].content;syncLines();
}
function syncLines(){const n=document.getElementById('codeEditor').value.split('\n').length;document.getElementById('line-nums').innerHTML=Array.from({length:n},(_,i)=>i+1).join('<br>');}
function autoSave(){SCRIPTS[curScript].content=document.getElementById('codeEditor').value;}
function newScript(){const name=prompt('Script name:','MyScript');if(!name)return;SCRIPTS.push({name:name+'.lua',content:'-- '+name+'\nprint("'+name+' loaded!")\n'});initScripts();loadScript(SCRIPTS.length-1);}
function runScript(){
  const code=document.getElementById('codeEditor').value;
  logCon('[Run] '+SCRIPTS[curScript].name+'...','ci');
  if(ws&&ws.readyState===1)send({type:'script_run',code});
  else showScriptOut(simLua(code));
}
function simLua(code){
  const lines=[];
  (code.match(/print\(([^)]+)\)/g)||[]).forEach(p=>lines.push({level:'log',text:p.slice(6,-1).replace(/['"]/g,'').replace('player.Name',myName)}));
  (code.match(/warn\(([^)]+)\)/g)||[]).forEach(w=>lines.push({level:'error',text:'[WARN] '+w.slice(5,-1).replace(/['"]/g,'')}));
  if(!lines.length)lines.push({level:'info',text:'Script executed (no output)'});
  lines.push({level:'success',text:'Done in '+(Math.random()*30+5).toFixed(1)+'ms'});
  return lines;
}
function showScriptOut(lines){lines.forEach(l=>logCon(l.text,l.level==='error'?'ce':l.level==='success'?'cs':l.level==='info'?'ci':'cl'));}
function logCon(text,cls){
  const c=document.getElementById('con-out');
  const d=document.createElement('div');d.className=cls||'cl';d.textContent=text;c.appendChild(d);
  if(c.children.length>100)c.removeChild(c.firstChild);c.scrollTop=c.scrollHeight;
}
function clearCon(){document.getElementById('con-out').innerHTML='<div class="ci">[BV] Console cleared.</div>';}
// ‚ïê‚ïê‚ïê JOYSTICK ‚ïê‚ïê‚ïê
function initJoystick(){
  const base=document.getElementById('joy-base'),stick=document.getElementById('joy-stick');
  const MAX=33;let tid=null,sx,sy;
  base.addEventListener('touchstart',e=>{const t=e.touches[0];const r=base.getBoundingClientRect();sx=r.left+r.width/2;sy=r.top+r.height/2;tid=t.identifier;e.preventDefault();},{passive:false});
  base.addEventListener('touchmove',e=>{
    const t=[...e.touches].find(x=>x.identifier===tid);if(!t)return;
    const dx=t.clientX-sx,dy=t.clientY-sy;const d=Math.sqrt(dx*dx+dy*dy),cl=Math.min(d,MAX),a=Math.atan2(dy,dx);
    const nx=Math.cos(a)*cl,ny=Math.sin(a)*cl;
    stick.style.transform='translate('+nx+'px,'+ny+'px)';joyX=nx/MAX;joyY=ny/MAX;e.preventDefault();
  },{passive:false});
  const end=()=>{stick.style.transform='';joyX=0;joyY=0;};
  base.addEventListener('touchend',end);base.addEventListener('touchcancel',end);
}
// ‚ïê‚ïê‚ïê PANEL SYSTEM ‚ïê‚ïê‚ïê
function showPanel(name){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('visible'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('visible');
  document.getElementById('nav-'+name)?.classList.add('active');
  if(name==='game'){initBPicker();updatePList();}
  if(name==='market')initMarket();
  if(name==='avatar'){if(!aR)initAvPanel();else{updateAvStats();buildAvMesh();}}
  if(name==='studio'&&!sR)initStudio3D();
}
function leaveGame(){
  cancelAnimationFrame(gAnim);
  if(document.pointerLockElement)document.exitPointerLock();
  document.getElementById('sidebar').style.display='none';
  document.getElementById('screen-lobby').classList.add('visible');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('visible'));
  remotePlayers={};showNotif('Sampai jumpa! üëã','üéÆ');
}
// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function showNotif(msg,icon){
  document.querySelectorAll('.notif').forEach(n=>n.remove());
  const n=document.createElement('div');n.className='notif';n.innerHTML=(icon||'‚úÖ')+' '+msg;document.body.appendChild(n);
  setTimeout(()=>n.remove(),2800);
}
window.addEventListener('resize',()=>{
  if(gR){const cv=document.getElementById('gameCanvas');gR.setSize(cv.parentElement.clientWidth,cv.parentElement.clientHeight,false);gC.aspect=cv.parentElement.clientWidth/cv.parentElement.clientHeight;gC.updateProjectionMatrix();}
});
</script>
</body>
</html>
